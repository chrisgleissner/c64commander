apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'
apply plugin: 'jacoco'

def keystoreProps = new Properties()
def envFile = rootProject.file("../.env")
def keyPropsFile = rootProject.file("key.properties")

if (envFile.exists()) {
    envFile.withInputStream { stream ->
        keystoreProps.load(stream)
    }
}

if (keyPropsFile.exists()) {
    keyPropsFile.withInputStream { stream ->
        keystoreProps.load(stream)
    }
}

logger.lifecycle("Signing config keys loaded: ${keystoreProps.keySet()}")

android {
    namespace "uk.gleissner.c64commander"
    compileSdk rootProject.ext.compileSdkVersion
    defaultConfig {
        applicationId "uk.gleissner.c64commander"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        def envVersionCode = System.getenv("VERSION_CODE")
        def envVersionName = System.getenv("VERSION_NAME")
        versionCode (envVersionCode ? envVersionCode.toInteger() : 2)
        versionName (envVersionName ?: "0.1.1")
        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
        ndk {
            abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64"
        }
        aaptOptions {
             // Files and dirs to omit from the packaged assets dir, modified to accommodate modern web apps.
             // Default: https://android.googlesource.com/platform/frameworks/base/+/282e181b58cf72b6ca770dc7ca5f91f135444502/tools/aapt/AaptAssets.cpp#61
            ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~'
        }
    }
    signingConfigs {
        release {
            def isReleaseBuild = gradle.startParameter.taskNames.any { it.toLowerCase().contains("release") }
            def storeFilePathValue = (keystoreProps["storeFile"] ?: keystoreProps["KEYSTORE_STORE_FILE"] ?: "../keystore/release.keystore")?.toString()
            def storePasswordValue = (keystoreProps["storePassword"] ?: keystoreProps["KEYSTORE_STORE_PASSWORD"] ?: System.getenv("KEYSTORE_STORE_PASSWORD"))?.toString()
            def keyAliasValue = (keystoreProps["keyAlias"] ?: keystoreProps["KEYSTORE_KEY_ALIAS"] ?: System.getenv("KEYSTORE_KEY_ALIAS") ?: "c64commander")?.toString()
            def keyPasswordValue = (keystoreProps["keyPassword"] ?: keystoreProps["KEYSTORE_KEY_PASSWORD"] ?: System.getenv("KEYSTORE_KEY_PASSWORD") ?: storePasswordValue)?.toString()

            if (isReleaseBuild) {
                if (!storeFilePathValue) {
                    throw new RuntimeException("Missing keystore file path. Set KEYSTORE_STORE_FILE or storeFile.")
                }
                if (!storePasswordValue) {
                    throw new RuntimeException("Missing keystore password. Set KEYSTORE_STORE_PASSWORD or storePassword.")
                }
                if (!keyAliasValue) {
                    throw new RuntimeException("Missing key alias. Set KEYSTORE_KEY_ALIAS or keyAlias.")
                }
                if (!keyPasswordValue) {
                    throw new RuntimeException("Missing key password. Set KEYSTORE_KEY_PASSWORD or keyPassword.")
                }

                def resolvedStoreFile = file(storeFilePathValue).absoluteFile
                if (!resolvedStoreFile.exists()) {
                    throw new RuntimeException("Keystore not found at: ${resolvedStoreFile}")
                }

                logger.lifecycle("Signing config: storeFileExists=${resolvedStoreFile.exists()}, storePasswordSet=${storePasswordValue != null}, keyAliasSet=${keyAliasValue != null}, keyPasswordSet=${keyPasswordValue != null}")

                storeFile = resolvedStoreFile
                storePassword = storePasswordValue
                keyAlias = keyAliasValue
                keyPassword = keyPasswordValue
                storeType = "PKCS12"
            }
        }
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.release
        }
    }
    testOptions {
        unitTests.returnDefaultValues = true
    }
    sourceSets {
        androidTest {
            assets.srcDirs += ['src/test/fixtures']
        }
    }
}

dependencies {
    implementation fileTree(include: ['*.jar'], dir: 'libs')
    implementation "androidx.appcompat:appcompat:$androidxAppCompatVersion"
    implementation "androidx.coordinatorlayout:coordinatorlayout:$androidxCoordinatorLayoutVersion"
    implementation "androidx.core:core-splashscreen:$coreSplashScreenVersion"
    implementation "androidx.datastore:datastore-preferences:$dataStoreVersion"
    implementation "androidx.documentfile:documentfile:1.0.1"
    implementation "org.apache.commons:commons-compress:1.27.1"
    implementation "commons-net:commons-net:3.9.0"
    implementation "org.tukaani:xz:1.10"
    // TODO Remove if commons-compress + org.tukaani:xz work for HVSC 7z files
    implementation "com.sorrowblue.sevenzipjbinding:7-Zip-JBinding-4Android:16.02-2.03"
    implementation project(':capacitor-android')
    testImplementation "junit:junit:$junitVersion"
    testImplementation "org.xerial:sqlite-jdbc:3.46.0.0"
    testImplementation "org.json:json:20240303"
    testImplementation "org.robolectric:robolectric:4.11.1"
    testImplementation "org.mockito:mockito-core:5.8.0"
    testImplementation "androidx.test:core:1.5.0"
    testImplementation "androidx.test.ext:junit:1.1.5"
    testImplementation "org.jetbrains.kotlinx:kotlinx-coroutines-test:1.7.3"
    testImplementation "net.sf.sevenzipjbinding:sevenzipjbinding:16.02-2.01"
    testImplementation "net.sf.sevenzipjbinding:sevenzipjbinding-all-platforms:16.02-2.01"
    androidTestImplementation "androidx.test.ext:junit:$androidxJunitVersion"
    androidTestImplementation "androidx.test.espresso:espresso-core:$androidxEspressoCoreVersion"
    implementation project(':capacitor-cordova-android-plugins')
}

// Jacoco configuration for code coverage
jacoco {
    toolVersion = "0.8.12"
}

tasks.register('jacocoTestReport', JacocoReport) {
    dependsOn "testDebugUnitTest", "testReleaseUnitTest"
    
    reports {
        xml.required = true
        html.required = true
        csv.required = false
    }
    
    def fileFilter = [
        '**/R.class',
        '**/R$*.class',
        '**/BuildConfig.*',
        '**/Manifest*.*',
        '**/*Test*.*',
        '**/DrivePartition.class',
        '**/FeatureFlagsPlugin*.class',
        '**/FolderPickerPlugin*.class',
        '**/HvscIngestionPlugin*.class',
        '**/MainActivity.class',
        '**/MockC64UPlugin*.class',
        '**/MockC64UServer*.class',
        '**/MockC64UState*.class',
        '**/MockFtpServer*.class',
        '**/MockConfigDetails.class',
        '**/AndroidHvscDatabase*.class',
        '**/HvscArchiveInspector*.class',
        '**/HvscDownloadClient$DefaultImpls.class',
        '**/HvscFolderListing.class',
        '**/HvscIngestionService*.class',
        '**/Hvsc7ZipJBindingExtractor*.class',
        '**/ExtractionResult.class',
        '**/HvscIngestionService$prepareArchive$1.class',
        '**/HvscSchema*.class',
        '**/HvscSongDetail.class',
        '**/SevenZipJBindingArchiveReader*.class',
        'android/**/*.class'
    ]
    
    def debugTree = fileTree(dir: "$buildDir/tmp/kotlin-classes/debug", excludes: fileFilter)
    def mainSrc = "$projectDir/src/main/java"
    
    sourceDirectories.setFrom(files([mainSrc]))
    classDirectories.setFrom(files([debugTree]))
    executionData.setFrom(fileTree(dir: buildDir, includes: [
        'jacoco/testDebugUnitTest.exec',
        'jacoco/testReleaseUnitTest.exec',
        'outputs/code_coverage/debugAndroidTest/connected/**/*.ec'
    ]))
}

tasks.register('jacocoTestCoverageVerification', JacocoCoverageVerification) {
    dependsOn "testDebugUnitTest", "testReleaseUnitTest"

    def fileFilter = [
        '**/R.class',
        '**/R$*.class',
        '**/BuildConfig.*',
        '**/Manifest*.*',
        '**/*Test*.*',
        '**/DrivePartition.class',
        '**/FeatureFlagsPlugin*.class',
        '**/FolderPickerPlugin*.class',
        '**/HvscIngestionPlugin*.class',
        '**/MainActivity.class',
        '**/MockC64UPlugin*.class',
        '**/MockC64UServer*.class',
        '**/MockC64UState*.class',
        '**/MockFtpServer*.class',
        '**/MockConfigDetails.class',
        '**/AndroidHvscDatabase*.class',
        '**/HvscArchiveInspector*.class',
        '**/HvscDownloadClient$DefaultImpls.class',
        '**/HvscFolderListing.class',
        '**/HvscIngestionService*.class',
        '**/Hvsc7ZipJBindingExtractor*.class',
        '**/ExtractionResult.class',
        '**/HvscIngestionService$prepareArchive$1.class',
        '**/HvscSchema*.class',
        '**/HvscSongDetail.class',
        '**/SevenZipJBindingArchiveReader*.class',
        'android/**/*.class'
    ]

    def debugTree = fileTree(dir: "$buildDir/tmp/kotlin-classes/debug", excludes: fileFilter)
    classDirectories.setFrom(files([debugTree]))
    sourceDirectories.setFrom(files(["$projectDir/src/main/java"]))
    executionData.setFrom(fileTree(dir: buildDir, includes: [
        'jacoco/testDebugUnitTest.exec',
        'jacoco/testReleaseUnitTest.exec',
        'outputs/code_coverage/debugAndroidTest/connected/**/*.ec'
    ]))

    violationRules {
        rule {
            element = 'BUNDLE'
            limit {
                counter = 'INSTRUCTION'
                value = 'COVEREDRATIO'
                minimum = 0.75
            }
        }
    }
}

apply from: 'capacitor.build.gradle'

try {
    def servicesJSON = file('google-services.json')
    if (servicesJSON.text) {
        apply plugin: 'com.google.gms.google-services'
    }
} catch(Exception e) {
    logger.info("google-services.json not found, google-services plugin not applied. Push Notifications won't work")
}
