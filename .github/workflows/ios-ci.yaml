name: iOS CI

on:
  pull_request:
  push:
    branches: ["main"]
    tags: ["*"]
  workflow_dispatch:

permissions:
  contents: write

env:
  CI_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
  APP_ID: uk.gleissner.c64commander
  IOS_ROLLOUT_STAGE: ${{ vars.IOS_ROLLOUT_STAGE || 'A' }}

# Rollout policy:
# - Stage A (default): iOS jobs are informative (non-blocking).
# - Stage B: ios-build-simulator and ios-maestro-tests become blocking required checks.
# - Stage C: ios-package-altstore is required on tag refs.
# Set repository variable IOS_ROLLOUT_STAGE to A, B, or C.
#
# iOS failure triage checklist:
# 1) Runtime missing: inspect `xcrun simctl list runtimes` in job logs.
# 2) Simulator unavailable: inspect `xcrun simctl list devicetypes` and selected device.
# 3) Maestro selector drift: inspect `test-results/maestro/**` artifacts and update flows/selectors.
# 4) Packaging errors: inspect archive/zip steps and verify `ios/build/App.xcarchive` content.

jobs:
  ios-prepare:
    name: iOS | Prepare
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CI_SHA }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Resolve app version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" && -n "${GITHUB_REF_NAME}" ]]; then
            APP_VERSION="${GITHUB_REF_NAME}"
          else
            APP_VERSION="$(git describe --tags --exact-match 2>/dev/null || true)"
            if [[ -z "$APP_VERSION" ]]; then
              APP_VERSION="$(node -p "require('./package.json').version" 2>/dev/null || true)"
            fi
          fi
          if [[ -z "$APP_VERSION" ]]; then
            APP_VERSION="0.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

      - name: Print Xcode version
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Upload prepared iOS workspace
        uses: actions/upload-artifact@v4
        with:
          name: ios-prepared-workspace
          path: |
            ios/
            dist/
          if-no-files-found: error

  ios-build-simulator:
    name: iOS | Build simulator
    runs-on: macos-15
    needs: ios-prepare
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CI_SHA }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Download prepared iOS workspace
        uses: actions/download-artifact@v4
        with:
          name: ios-prepared-workspace
          path: .

      - name: Ensure CocoaPods scripts are executable
        run: |
          set -euo pipefail
          find ios/App/Pods/Target\ Support\ Files -name "*.sh" -type f -exec chmod +x {} +

      - name: Build app for simulator
        run: |
          set -euo pipefail
          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO

      - name: Upload simulator app artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-app
          path: ios/build/Build/Products/Debug-iphonesimulator/App.app
          if-no-files-found: error

  ios-maestro-tests:
    name: iOS | Maestro ${{ matrix.flow }}
    runs-on: macos-15
    needs: ios-build-simulator
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        flow:
          - ios-smoke-launch
          - ios-playback-basics
          - ios-diagnostics-export
          - ios-ftp-browse
          - ios-local-import
          - ios-secure-storage-persist
          - ios-import-playback
          - ios-hvsc-browse
          - ios-config-persistence

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CI_SHA }}

      - name: Download simulator app
        uses: actions/download-artifact@v4
        with:
          name: ios-simulator-app
          path: App.app

      - name: Cache Maestro CLI
        uses: actions/cache@v4
        with:
          path: ~/.maestro
          key: maestro-cli-${{ runner.os }}-v1

      - name: Install Maestro CLI
        run: |
          set -euo pipefail
          if [[ -x "$HOME/.maestro/bin/maestro" ]]; then
            echo "Maestro CLI cached"
            "$HOME/.maestro/bin/maestro" --version
          else
            curl -Ls "https://get.maestro.mobile.dev" | bash
            "$HOME/.maestro/bin/maestro" --version
          fi
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"

      - name: Select simulator runtime and boot
        id: simulator
        run: |
          set -euo pipefail

          python3 <<'PY'
          import json
          import os
          import subprocess
          import sys

          runtimes = json.loads(
              subprocess.check_output(["xcrun", "simctl", "list", "runtimes", "-j"], text=True)
          ).get("runtimes", [])

          preferred_major_versions = [18, 17, 26]
          runtime_identifier = None
          for major in preferred_major_versions:
              for runtime in runtimes:
                  if not runtime.get("isAvailable", False):
                      continue
                  identifier = runtime.get("identifier", "")
                  if not identifier.startswith("com.apple.CoreSimulator.SimRuntime.iOS-"):
                      continue
                  suffix = identifier.split("iOS-", 1)[1]
                  major_part = suffix.split("-")[0]
                  try:
                      parsed_major = int(major_part)
                  except ValueError:
                      continue
                  if parsed_major == major:
                      runtime_identifier = identifier
                      break
              if runtime_identifier:
                  break

          if not runtime_identifier:
              print("No supported iOS runtime found for policy 18 -> 17 -> 26", file=sys.stderr)
              sys.exit(1)

          device_types = json.loads(
              subprocess.check_output(["xcrun", "simctl", "list", "devicetypes", "-j"], text=True)
          ).get("devicetypes", [])
          iphone_13 = next((d for d in device_types if d.get("name") == "iPhone 13" and d.get("isAvailable", True)), None)
          if not iphone_13:
              print("Simulator device type iPhone 13 is unavailable", file=sys.stderr)
              sys.exit(1)

          flow = os.environ.get("MATRIX_FLOW", "unknown")
          run_id = os.environ.get("GITHUB_RUN_ID", "local")
          run_attempt = os.environ.get("GITHUB_RUN_ATTEMPT", "1")
          sim_name = f"C64Commander-{flow}-{run_id}-{run_attempt}"

          udid = subprocess.check_output(
              ["xcrun", "simctl", "create", sim_name, iphone_13["identifier"], runtime_identifier],
              text=True,
            ).strip()
          subprocess.check_call(["xcrun", "simctl", "boot", udid])

          print(f"Waiting for simulator {udid} bootstatus (timeout 300s)...")
          try:
              bootstatus = subprocess.run(
                  ["xcrun", "simctl", "bootstatus", udid, "-b"],
                  capture_output=True,
                  text=True,
                  timeout=300,
              )
          except subprocess.TimeoutExpired:
              print(f"Simulator {udid} did not boot within timeout", file=sys.stderr)
              print(subprocess.check_output(["xcrun", "simctl", "list", "devices", runtime_identifier], text=True), file=sys.stderr)
              sys.exit(1)

          if bootstatus.returncode != 0:
              print("simctl bootstatus failed", file=sys.stderr)
              print(bootstatus.stdout, file=sys.stderr)
              print(bootstatus.stderr, file=sys.stderr)
              sys.exit(bootstatus.returncode)

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"runtime={runtime_identifier}\n")
              fh.write(f"device_type={iphone_13['identifier']}\n")
              fh.write(f"udid={udid}\n")
          PY
        env:
          MATRIX_FLOW: ${{ matrix.flow }}

      - name: Run Maestro flow with evidence capture (${{ matrix.flow }})
        env:
          MAESTRO_CLI_NO_ANALYTICS: 1
          CI: "true"
        run: |
          set -euo pipefail
          bash scripts/ci/ios-maestro-run-flow.sh \
            --flow "${{ matrix.flow }}" \
            --udid "${{ steps.simulator.outputs.udid }}" \
            --app-path "App.app"

      - name: Validate connectivity (${{ matrix.flow }})
        if: always()
        run: |
          bash scripts/ci/validate-ios-connectivity.sh "artifacts/ios/${{ matrix.flow }}" || true

      - name: Upload per-flow artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-maestro-${{ matrix.flow }}
          path: |
            artifacts/ios/${{ matrix.flow }}/**
            artifacts/ios/_infra/${{ matrix.flow }}/**
          if-no-files-found: warn

      - name: Shutdown and delete simulator
        if: always()
        run: |
          if [[ -n "${{ steps.simulator.outputs.udid }}" ]]; then
            xcrun simctl shutdown "${{ steps.simulator.outputs.udid }}" || true
            xcrun simctl delete "${{ steps.simulator.outputs.udid }}" || true
          fi

  ios-maestro-aggregate:
    name: iOS | Maestro aggregate
    runs-on: ubuntu-latest
    needs: ios-maestro-tests
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CI_SHA }}

      - name: Download all per-flow artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ios-maestro-*
          path: downloaded-artifacts
          merge-multiple: false

      - name: Aggregate evidence
        run: |
          set -euo pipefail
          mkdir -p artifacts/ios/_combined/flows

          # Re-root per-flow artifacts
          for flow_dir in downloaded-artifacts/ios-maestro-*/; do
            flow_name="$(basename "$flow_dir" | sed 's/^ios-maestro-//')"
            if [[ -d "$flow_dir" ]]; then
              # Handle nested artifact structure
              if [[ -d "$flow_dir/artifacts/ios/$flow_name" ]]; then
                cp -r "$flow_dir/artifacts/ios/$flow_name" "artifacts/ios/_combined/flows/$flow_name"
              elif [[ -d "$flow_dir/$flow_name" ]]; then
                cp -r "$flow_dir/$flow_name" "artifacts/ios/_combined/flows/$flow_name"
              else
                mkdir -p "artifacts/ios/_combined/flows/$flow_name"
                cp -r "$flow_dir"/* "artifacts/ios/_combined/flows/$flow_name/" 2>/dev/null || true
              fi
            fi
          done

          # Copy infra diagnostics if present
          for infra_dir in downloaded-artifacts/ios-maestro-*/artifacts/ios/_infra/*/; do
            if [[ -d "$infra_dir" ]]; then
              flow_name="$(basename "$infra_dir")"
              mkdir -p "artifacts/ios/_infra/$flow_name"
              cp -r "$infra_dir"/* "artifacts/ios/_infra/$flow_name/" 2>/dev/null || true
            fi
          done

      - name: Merge JUnit reports
        run: |
          set -euo pipefail
          python3 <<'MERGE'
          import xml.etree.ElementTree as ET
          import glob
          import json
          import os

          combined = ET.Element("testsuites")
          total_tests = 0
          total_failures = 0
          total_errors = 0
          total_time = 0.0
          flow_summaries = []

          for junit_path in sorted(glob.glob("artifacts/ios/_combined/flows/*/junit.xml")):
              flow_name = os.path.basename(os.path.dirname(junit_path))
              try:
                  tree = ET.parse(junit_path)
                  root = tree.getroot()
                  if root.tag == "testsuites":
                      for suite in root:
                          suite.set("name", f"{flow_name}/{suite.get('name', 'unknown')}")
                          combined.append(suite)
                          total_tests += int(suite.get("tests", "0"))
                          total_failures += int(suite.get("failures", "0"))
                          total_errors += int(suite.get("errors", "0"))
                          total_time += float(suite.get("time", "0"))
                  elif root.tag == "testsuite":
                      root.set("name", f"{flow_name}/{root.get('name', 'unknown')}")
                      combined.append(root)
                      total_tests += int(root.get("tests", "0"))
                      total_failures += int(root.get("failures", "0"))
                      total_errors += int(root.get("errors", "0"))
                      total_time += float(root.get("time", "0"))
                  flow_summaries.append({"flow": flow_name, "status": "parsed", "tests": total_tests})
              except Exception as e:
                  flow_summaries.append({"flow": flow_name, "status": f"error: {e}"})

          combined.set("tests", str(total_tests))
          combined.set("failures", str(total_failures))
          combined.set("errors", str(total_errors))
          combined.set("time", f"{total_time:.3f}")

          out_dir = "artifacts/ios/_combined"
          tree = ET.ElementTree(combined)
          tree.write(os.path.join(out_dir, "junit-merged.xml"), xml_declaration=True, encoding="unicode")

          # Summary JSON
          summary = {
              "totalTests": total_tests,
              "totalFailures": total_failures,
              "totalErrors": total_errors,
              "totalTimeSeconds": round(total_time, 3),
              "flows": flow_summaries,
          }
          with open(os.path.join(out_dir, "summary.json"), "w") as f:
              json.dump(summary, f, indent=2)

          # Timing summary
          timing_entries = []
          for timing_path in sorted(glob.glob("artifacts/ios/_combined/flows/*/timing.json")):
              try:
                  with open(timing_path) as f:
                      timing_entries.append(json.load(f))
              except Exception:
                  pass

          with open(os.path.join(out_dir, "timing-summary.json"), "w") as f:
              json.dump({"flows": timing_entries}, f, indent=2)

          print(f"Merged {len(flow_summaries)} flows: {total_tests} tests, {total_failures} failures, {total_errors} errors")
          MERGE

      - name: Run connectivity validation summary
        if: always()
        run: |
          set -euo pipefail
          python3 <<'VALIDATE'
          import json
          import glob
          import sys

          validations = []
          all_valid = True

          for path in sorted(glob.glob("artifacts/ios/_combined/flows/*/connectivity-validation.json")):
              try:
                  with open(path) as f:
                      v = json.load(f)
                      validations.append(v)
                      if not v.get("valid", True):
                          all_valid = False
              except Exception as e:
                  validations.append({"flow": path, "valid": False, "errors": [str(e)]})
                  all_valid = False

          summary = {
              "allValid": all_valid,
              "flowCount": len(validations),
              "validations": validations,
          }

          with open("artifacts/ios/_combined/connectivity-summary.json", "w") as f:
              json.dump(summary, f, indent=2)

          if not all_valid:
              print("::warning::Connectivity validation failed for some flows")
              for v in validations:
                  if not v.get("valid", True):
                      print(f"  FAIL: {v.get('flow', 'unknown')} - {v.get('errors', [])}")

          print(json.dumps(summary, indent=2))
          VALIDATE

      - name: Upload combined evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-maestro-evidence
          path: |
            artifacts/ios/_combined/**
            artifacts/ios/_infra/**
          if-no-files-found: warn

      - name: Create evidence archive on tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -euo pipefail
          cd artifacts/ios
          zip -qry ../../ios-maestro-evidence.zip _combined/ _infra/ 2>/dev/null || \
          zip -qry ../../ios-maestro-evidence.zip _combined/

      - name: Upload evidence archive on tag
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: ios-maestro-evidence-zip
          path: ios-maestro-evidence.zip
          if-no-files-found: warn

  ios-package-altstore:
    name: iOS | Package AltStore IPA
    runs-on: macos-15
    needs: ios-prepare

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CI_SHA }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Resolve app version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" && -n "${GITHUB_REF_NAME}" ]]; then
            APP_VERSION="${GITHUB_REF_NAME}"
          else
            APP_VERSION="$(git describe --tags --exact-match 2>/dev/null || true)"
            if [[ -z "$APP_VERSION" ]]; then
              APP_VERSION="$(node -p "require('./package.json').version" 2>/dev/null || true)"
            fi
          fi
          if [[ -z "$APP_VERSION" ]]; then
            APP_VERSION="0.0.${GITHUB_RUN_NUMBER}"
          fi
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

      - name: Download prepared iOS workspace
        uses: actions/download-artifact@v4
        with:
          name: ios-prepared-workspace
          path: .

      - name: Ensure CocoaPods scripts are executable
        run: |
          set -euo pipefail
          find ios/App/Pods/Target\ Support\ Files -name "*.sh" -type f -exec chmod +x {} +

      - name: Build unsigned iOS device app
        run: |
          set -euo pipefail
          mkdir -p ios/build
          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      - name: Package AltStore unsigned IPA
        run: |
          set -euo pipefail
          IPA_BASENAME="c64commander-${APP_VERSION}-altstore-unsigned"
          rm -rf ios/build/Payload
          mkdir -p ios/build/Payload
          cp -R ios/build/Build/Products/Release-iphoneos/App.app ios/build/Payload/App.app
          (
            cd ios/build
            zip -qry "${IPA_BASENAME}.ipa" Payload
          )
          shasum -a 256 "ios/build/${IPA_BASENAME}.ipa" | awk '{print $1}' > "ios/build/${IPA_BASENAME}.ipa.sha256"

      - name: Upload AltStore IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-altstore-unsigned-ipa
          path: |
            ios/build/c64commander-*-altstore-unsigned.ipa
            ios/build/c64commander-*-altstore-unsigned.ipa.sha256
          if-no-files-found: error

      - name: Publish AltStore IPA on tags
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ios/build/c64commander-*-altstore-unsigned.ipa
            ios/build/c64commander-*-altstore-unsigned.ipa.sha256

  ios-package-paid:
    name: iOS | Package paid signing
    runs-on: macos-15
    needs: ios-prepare
    if: vars.IOS_PAID_SIGNING_ENABLED == 'true'
    # Required repository variables/secrets when enabling this lane:
    # - vars.IOS_PAID_SIGNING_ENABLED=true
    # - secrets.IOS_BUILD_CERTIFICATE_BASE64
    # - secrets.IOS_P12_PASSWORD
    # - secrets.IOS_PROVISIONING_PROFILE_BASE64
    # - secrets.IOS_TEAM_ID
    # - secrets.IOS_SIGNING_IDENTITY

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CI_SHA }}

      - name: Download prepared iOS workspace
        uses: actions/download-artifact@v4
        with:
          name: ios-prepared-workspace
          path: .

      - name: Ensure CocoaPods scripts are executable
        run: |
          set -euo pipefail
          find ios/App/Pods/Target\ Support\ Files -name "*.sh" -type f -exec chmod +x {} +

      - name: Paid signing lane guard
        run: |
          set -euo pipefail
          echo "Paid signing lane enabled. Configure certificate import, provisioning profile install, and export options before release use."
