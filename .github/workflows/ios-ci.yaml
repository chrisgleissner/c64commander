name: iOS CI

on:
  pull_request:
  push:
    branches: ["main"]
    tags: ["*"]
  workflow_dispatch:

permissions:
  contents: read

env:
  CI_SHA: ${{ github.event.pull_request.head.sha || github.sha }}

jobs:
  ios-prepare:
    name: iOS | Prepare
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CI_SHA }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Print Xcode version
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Build web assets
        run: npm run build

      - name: Sync Capacitor iOS
        run: npx cap sync ios

      - name: Upload prepared iOS workspace
        uses: actions/upload-artifact@v4
        with:
          name: ios-prepared-workspace
          path: |
            ios/
            dist/
          if-no-files-found: error

  ios-build-simulator:
    name: iOS | Build simulator
    runs-on: macos-15
    needs: ios-prepare

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CI_SHA }}

      - name: Download prepared iOS workspace
        uses: actions/download-artifact@v4
        with:
          name: ios-prepared-workspace
          path: .

      - name: Select simulator runtime and device
        id: simulator
        run: |
          set -euo pipefail
          xcrun simctl list runtimes
          xcrun simctl list devicetypes

          python3 <<'PY'
          import json
          import os
          import re
          import subprocess
          import sys

          runtime_dump = subprocess.check_output(["xcrun", "simctl", "list", "runtimes", "-j"], text=True)
          runtimes = json.loads(runtime_dump).get("runtimes", [])

          preferred_major_versions = [26, 18, 17]
          selected = None

          for major in preferred_major_versions:
              for runtime in runtimes:
                  if not runtime.get("isAvailable", False):
                      continue
                  identifier = runtime.get("identifier", "")
                  if not identifier.startswith("com.apple.CoreSimulator.SimRuntime.iOS-"):
                      continue
                  suffix = identifier.split("iOS-", 1)[1]
                  major_part = suffix.split("-")[0]
                  try:
                      parsed_major = int(major_part)
                  except ValueError:
                      continue
                  if parsed_major == major:
                      selected = runtime
                      break
              if selected:
                  break

          if not selected:
              print("No supported iOS runtime found for policy 26 -> 18 -> 17", file=sys.stderr)
              sys.exit(1)

          device_types_dump = subprocess.check_output(["xcrun", "simctl", "list", "devicetypes", "-j"], text=True)
          device_types = json.loads(device_types_dump).get("devicetypes", [])
          iphone_13 = next((d for d in device_types if d.get("name") == "iPhone 13" and d.get("isAvailable", True)), None)

          if not iphone_13:
              print("Simulator device type iPhone 13 is unavailable", file=sys.stderr)
              sys.exit(1)

          runtime_identifier = selected["identifier"]
          device_type_identifier = iphone_13["identifier"]
          sim_name = "C64Commander-CI"

          create = subprocess.run(
              ["xcrun", "simctl", "create", sim_name, device_type_identifier, runtime_identifier],
              capture_output=True,
              text=True,
          )
          if create.returncode != 0:
              print(create.stderr, file=sys.stderr)
              sys.exit(create.returncode)

          udid = create.stdout.strip()
          subprocess.check_call(["xcrun", "simctl", "boot", udid])
          subprocess.check_call(["xcrun", "simctl", "bootstatus", udid, "-b"])

            github_output = os.environ.get("GITHUB_OUTPUT")
            if not github_output:
              print("GITHUB_OUTPUT is not set", file=sys.stderr)
              sys.exit(1)

            with open(github_output, "a", encoding="utf-8") as fh:
              fh.write(f"runtime={runtime_identifier}\n")
              fh.write(f"device_type={device_type_identifier}\n")
              fh.write(f"udid={udid}\n")
          PY

      - name: Print selected simulator
        run: |
          echo "Selected runtime: ${{ steps.simulator.outputs.runtime }}"
          echo "Selected device type: ${{ steps.simulator.outputs.device_type }}"
          echo "Selected simulator UDID: ${{ steps.simulator.outputs.udid }}"

      - name: Build app for simulator
        run: |
          set -euo pipefail
          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "id=${{ steps.simulator.outputs.udid }}" \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO

      - name: Upload simulator app artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-app
          path: ios/build/Build/Products/Debug-iphonesimulator/App.app
          if-no-files-found: error

      - name: Shutdown and delete simulator
        if: always()
        run: |
          if [[ -n "${{ steps.simulator.outputs.udid }}" ]]; then
            xcrun simctl shutdown "${{ steps.simulator.outputs.udid }}" || true
            xcrun simctl delete "${{ steps.simulator.outputs.udid }}" || true
          fi
