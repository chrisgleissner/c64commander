appId: uk.gleissner.c64commander
env:
  SHORT_TIMEOUT: ${SHORT_TIMEOUT || "5000"}
  TIMEOUT: ${TIMEOUT || "15000"}
  LONG_TIMEOUT: ${LONG_TIMEOUT || "20000"}
tags:
  - device
  - probe
  - ci-critical
---
# Verify JS continues executing while the screen is locked.
# Requires VITE_ENABLE_TEST_PROBES=1 in the build.

- runFlow: subflows/launch-and-wait.yaml

- extendedWaitUntil:
    visible:
      id: "test-heartbeat"
    timeout: ${TIMEOUT}

# Read the initial heartbeat counter value
- copyTextFrom:
    id: "test-heartbeat"
- evalScript: ${output.initialHeartbeat = Number(maestro.copiedText)}

# Lock the screen
- pressKey: Lock

# Unlock the screen
- pressKey: Lock

# Wait for UI to become responsive again
- extendedWaitUntil:
    visible:
      text: "Home"
    timeout: ${TIMEOUT}

- extendedWaitUntil:
    visible:
      id: "test-heartbeat"
    timeout: ${TIMEOUT}

# Read the heartbeat again
- copyTextFrom:
    id: "test-heartbeat"
- evalScript: ${output.finalHeartbeat = Number(maestro.copiedText)}

# Assert the heartbeat advanced (JS kept running while screen was locked)
- assertTrue: ${output.finalHeartbeat > output.initialHeartbeat}

# Assert the counter is a valid number and the advance is bounded
- assertTrue: ${!isNaN(output.initialHeartbeat) && !isNaN(output.finalHeartbeat)}
- evalScript: ${output.heartbeatDelta = output.finalHeartbeat - output.initialHeartbeat}
- assertTrue: ${output.heartbeatDelta >= 1 && output.heartbeatDelta <= 50}
- takeScreenshot: background-execution-verified
