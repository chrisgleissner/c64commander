# Smoke test for mounted HVSC-like library via Android file picker
# Requires /sdcard/Download/C64Music to exist (generated by smoke runner)

appId: uk.gleissner.c64commander
tags:
  - hvsc
  - slow
  - file-picker
  - device
env:
  LONG_TIMEOUT: ${LONG_TIMEOUT || "15000"}
  SHORT_TIMEOUT: ${SHORT_TIMEOUT || "5000"}
  TIMEOUT: ${TIMEOUT || "15000"}
---
- runFlow: subflows/open-play-add-items.yaml
- scrollUntilVisible:
    element:
      id: "import-option-local"
    direction: DOWN
    timeout: ${TIMEOUT}
- tapOn:
    id: "import-option-local"

# Handle permission dialogs (optional - may not appear on all devices)
- tapOn:
    text: "Allow"
    optional: true
- tapOn:
    text: "Allow access"
    optional: true
- tapOn:
    text: "Allow all the time"
    optional: true

- extendedWaitUntil:
    visible:
      id: com.google.android.documentsui:id/toolbar
    timeout: ${SHORT_TIMEOUT}
- waitForAnimationToEnd
- takeScreenshot: picker-roots

# Navigate file picker to Downloads/C64Music
- tapOn:
    text: "Browse"
    optional: true
- waitForAnimationToEnd
- scrollUntilVisible:
    element: "Internal storage"
    direction: DOWN
    timeout: ${TIMEOUT}
- tapOn:
    text: "Internal storage"
    optional: true
- scrollUntilVisible:
    element: "Downloads"
    direction: DOWN
    timeout: ${TIMEOUT}
- tapOn:
    text: "Downloads"
    optional: true
- tapOn:
    text: "Download"
    optional: true
- scrollUntilVisible:
    element: "C64Music"
    direction: DOWN
    timeout: ${TIMEOUT}
- tapOn: "C64Music"
- extendedWaitUntil:
    visible: "Use this folder"
    timeout: ${SHORT_TIMEOUT}
- tapOn: "Use this folder"
- tapOn:
    text: "Allow"
    optional: true

# Back in app: wait for playlist to populate
- extendedWaitUntil:
    visible: "Playlist"
    timeout: ${TIMEOUT}
- scrollUntilVisible:
    element: "35_Years.sid"
    direction: DOWN
    timeout: ${LONG_TIMEOUT}
- takeScreenshot: playlist-populated

# Filter to SID-only
- tapOn: "MOD music"
- tapOn: "PRG program"
- tapOn: "CRT cartridge"
- tapOn: "Disk image"

- scrollUntilVisible:
    element: "35_Years.sid"
    direction: DOWN
    timeout: ${TIMEOUT}
- tapOn: "35_Years.sid"

- extendedWaitUntil:
    visible: "Add items to playlist"
    timeout: ${SHORT_TIMEOUT}
- tapOn: "Add items to playlist"
- waitForAnimationToEnd
- launchApp:
    clearState: false
- extendedWaitUntil:
    visible:
      text: "Play"
    timeout: ${SHORT_TIMEOUT}
- tapOn:
    point: "25%,95%"
- extendedWaitUntil:
    visible: "Playlist"
    timeout: ${TIMEOUT}
- scrollUntilVisible:
    element: "35_Years.sid"
    direction: DOWN
    timeout: ${TIMEOUT}
- tapOn: "35_Years.sid"

# Assert playback is active
- tapOn:
    id: "playlist-play"
- extendedWaitUntil:
    visible: "Pause"
    timeout: ${SHORT_TIMEOUT}
- assertVisible: "35_Years.sid"
- assertNotVisible: "Playback failed"
- assertNotVisible: "No supported files"
- assertNotVisible: "Add items failed"
- takeScreenshot: now-playing

# Cleanup: pause playback and clear the playlist for downstream flows.
- tapOn:
    text: "Pause"
    optional: true
- tapOn:
    text: "Clear playlist"
    optional: true
- tapOn:
    text: "Clear"
    optional: true
- tapOn:
    text: "Remove"
    optional: true
