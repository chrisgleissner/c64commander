# Smoke test for mounted HVSC-like library via Android file picker
# Requires /sdcard/Download/C64Music to exist (generated by smoke runner)

appId: uk.gleissner.c64commander
tags:
  - hvsc
  - slow
  - file-picker
  - device
env:
  SHORT_TIMEOUT: ${SHORT_TIMEOUT || "10000"}
  TIMEOUT: ${TIMEOUT || "30000"}
  LONG_TIMEOUT: ${LONG_TIMEOUT || "60000"}
---
- runFlow: subflows/open-play-add-items.yaml
- scrollUntilVisible:
    element:
      id: "import-option-local"
    direction: DOWN
    timeout: ${TIMEOUT}
- tapOn:
    id: "import-option-local"
- takeScreenshot: picker-open

# Handle permission dialogs (optional - may not appear on all devices)
- tapOn:
    text: "Allow"
    optional: true
- tapOn:
    text: "Allow access"
    optional: true
- tapOn:
    text: "Allow all the time"
    optional: true

- extendedWaitUntil:
    visible:
      id: com.google.android.documentsui:id/toolbar
    timeout: ${SHORT_TIMEOUT}

- swipe:
    direction: RIGHT
    duration: 800
- tapOn:
    text: "Browse"
    optional: true
- tapOn:
    id: com.google.android.documentsui:id/roots_toggle
    optional: true
- tapOn:
    text: "Show roots"
    optional: true
- tapOn:
    text: "Downloads"
    optional: true
- tapOn:
    text: "Download"
    optional: true
- scrollUntilVisible:
    element: "C64Music"
    direction: DOWN
    timeout: ${TIMEOUT}
- takeScreenshot: picker-downloads
- tapOn: "C64Music"
- takeScreenshot: picker-c64music
- extendedWaitUntil:
    visible: "Use this folder"
    timeout: ${SHORT_TIMEOUT}
- tapOn: "Use this folder"
- tapOn:
    text: "Allow"
    optional: true

# Back in app: wait for playlist to populate
- extendedWaitUntil:
    visible: "Play Files"
    timeout: ${TIMEOUT}
- scrollUntilVisible:
    element: "35_Years.sid"
    direction: DOWN
    timeout: ${LONG_TIMEOUT}
- takeScreenshot: playlist-populated

# Filter to SID-only
- tapOn: "MOD music"
- tapOn: "PRG program"
- tapOn: "CRT cartridge"
- tapOn: "Disk image"
- takeScreenshot: filter-sid-only

- scrollUntilVisible:
    element: "35_Years.sid"
    direction: DOWN
    timeout: ${TIMEOUT}
- tapOn: "35_Years.sid"

# Assert playback is active
- extendedWaitUntil:
    visible: "Stop"
    timeout: ${SHORT_TIMEOUT}
- assertVisible: "35_Years.sid"
- assertNotVisible: "Playback failed"
- assertNotVisible: "No supported files"
- assertNotVisible: "Add items failed"
- takeScreenshot: now-playing
