# Verify the Local source option is visible in the source picker, then
# import a file from C64U and verify playback.
#
# On iOS WKWebView the showDirectoryPicker API is unavailable, so tapping
# "Local" would trigger a native UIDocumentPickerViewController that blocks
# Maestro. Instead we verify visibility of the Local option and then use the
# C64U FTP source to complete a full import-and-play cycle.

appId: uk.gleissner.c64commander
env:
  LONG_TIMEOUT: ${LONG_TIMEOUT || "20000"}
  SHORT_TIMEOUT: ${SHORT_TIMEOUT || "5000"}
  TIMEOUT: ${TIMEOUT || "15000"}
tags:
  - ios
  - ci-critical-ios
---
- runFlow: subflows/ios-open-play-add-items.yaml

# Assert Local source is visible (smoke check).
- assertVisible: "Add file / folder from Local"
- takeScreenshot: ios-local-source-visible

# Use C64U source to import a file (Local cannot complete on WKWebView).
- tapOn:
    text: "Add file / folder from C64U"
- waitForAnimationToEnd

# Browse mock FTP tree: root → Usb0 → Music → Mock_Tune_0001.sid
# Use aria-label selectors (reliable on WKWebView) and LONG_TIMEOUT for FTP.
- retry:
    maxRetries: 3
    commands:
      # On CI the initial directory can vary (root, Usb0, or Music).
      # Use optional navigation taps and converge on the target SID entry.
      - tapOn:
          text: "Open Usb0"
          optional: true
      - tapOn:
          text: "Open USB0"
          optional: true
      - tapOn:
          text: "Usb0"
          optional: true
      - tapOn:
          text: "USB0"
          optional: true
      - tapOn:
          text: "Open Music"
          optional: true
      - tapOn:
          text: "Music"
          optional: true
      - extendedWaitUntil:
          visible: "Select Mock_Tune_0001.sid"
          timeout: ${LONG_TIMEOUT}

- tapOn: "Select Mock_Tune_0001.sid"
- tapOn: "Add to playlist"
- waitForAnimationToEnd

# Verify the file landed in the playlist.
- extendedWaitUntil:
    visible: "Mock_Tune_0001.sid"
    timeout: ${TIMEOUT}
- takeScreenshot: ios-local-import-playlist

# Start playback via transport control (aria-label="Play").
# index: 1 picks the playlist transport button, not the "Play" tab.
- tapOn:
    text: "Play"
    index: 1
- extendedWaitUntil:
    visible: "Stop"
    timeout: ${TIMEOUT}
- assertNotVisible: "Playback failed"
- takeScreenshot: ios-local-import-playing
