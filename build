#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APK_DEFAULT=""

RUN_INSTALL=true
RUN_BUILD=true
RUN_TEST=true
RUN_ANDROID_TESTS=false
RUN_APK=true
RUN_INSTALL_APK=false
RUN_EMULATOR=false
RUN_SCREENSHOTS=false
RUN_TEST_UNIT=false
RUN_TEST_E2E=false
RUN_TEST_E2E_CI=false
RUN_TEST_MAESTRO_CI=false
RUN_TEST_MAESTRO_ALL=false
RUN_TEST_MAESTRO_TAGS=false
RUN_VALIDATE_EVIDENCE=false
RUN_COVERAGE=false
RUN_ANDROID_COVERAGE=true
RUN_SCREENSHOTS_ONLY=false
RUN_VIDEO=false
RUN_FUZZ=false
RUN_SMOKE_ANDROID_EMULATOR=false
RUN_SMOKE_ANDROID_REAL=false
RUN_FORMAT=true
RUN_DUMP_C64U_CONFIG=false
RUN_CONTRACT_TEST=false
PLAYWRIGHT_DEVICES=""
PLAYWRIGHT_PORT_RESOLVED=false
APK_PATH=""
DEVICE_ID=""
TEST_APK_PATH=""
TEST_DEVICE_ID=""
SKIP_INSTALL=false
SKIP_BUILD=false
SKIP_TESTS=false
SKIP_APK=false
SKIP_FORMAT=false
INSTALL_APK=false
FUZZ_SEED=""
FUZZ_STEPS=""
FUZZ_TIME_BUDGET=""
FUZZ_LAST_INTERACTIONS=""
FUZZ_RETAIN_SUCCESS=""
FUZZ_MIN_SESSION_STEPS=""
FUZZ_NO_PROGRESS_STEPS=""
FUZZ_PROGRESS_TIMEOUT=""
C64U_TARGET="mock"
C64U_HOST="C64U"
C64U_TARGET_SET=false
C64U_HOST_SET=false
RECORD_TRACES=false
TRACE_OUTPUT_DIR=""
TRACE_SUITE=""
MAESTRO_TAGS=""
GRADLE_MAX_WORKERS="${GRADLE_MAX_WORKERS:-6}"
export GRADLE_MAX_WORKERS
CONTRACT_MODE="safe"
CONTRACT_AUTH="off"
CONTRACT_PASSWORD=""
CONTRACT_ALLOW_RESET=false
CONTRACT_DISK_PATH=""
CONTRACT_DISK_DRIVE="a"
CONTRACT_DISK_TYPE="d64"
CONTRACT_DISK_MODE="readonly"
CONTRACT_SID_PATH=""
CONTRACT_SID_SONGNR=""
CONTRACT_PRG_PATH=""
CONTRACT_PRG_ACTION="run"
PRIMARY_ACTION=""
PRIMARY_ACTION_SOURCE=""
BUILD_FLAGS=()
TEST_MODIFIERS=()
TEST_APK_FLAGS=()
FUZZ_FLAGS=()
CONTRACT_FLAGS=()
TARGET_FLAGS=()

usage() {
  cat <<'EOF'
build - C64 Commander local build helper

Usage:
  ./build [primary-action] [options]

Default (no options):
  - Install deps
  - Build web app + sync
  - Run tests
  - Build debug APK

Primary actions (exactly one; default build when omitted):
  --test-unit
  --test-e2e
  --test-e2e-ci
  --test-maestro-ci
  --test-maestro-all
  --test-maestro-tags <tags>
  --test-fuzz
  --test-contract
  --test-smoke
  --screenshots
  --screenshots-only
  --video
  --emulator
  --dump-c64u-config

Build domain (default build only):
  --skip-install
  --skip-build
  --skip-tests
  --skip-apk
  --skip-format
  --install-apk            Install APK to a connected Android device (via adb)
  --apk-path <path>        APK path to install (default: android/app/build/outputs/apk/debug/app-debug.apk)
  --device-id <id>         Device ID for adb (optional). If omitted, picks the first real phone.

Test modifiers (require one --test-* primary action):
  --coverage               Run coverage pipeline (unit + e2e)
  --validate-evidence      Validate Playwright evidence structure
  --record-traces          Record golden traces during Playwright runs
  --trace-output-dir <path> Output directory for golden traces (default: playwright/fixtures/traces/golden)
  --trace-suite <name>     Optional suite name to scope trace recording
  --devices <list>         Device profiles for Playwright (phone, tablet, phone,tablet, all)
  --android-tests          Run Android instrumentation tests (requires a device/emulator)
  --skip-android-tests     Skip Android instrumentation tests
  --skip-android-coverage  Skip Android Jacoco coverage check
  --test-apk-path <path>   APK path override for Maestro/smoke tests
  --test-device-id <id>    adb device id for Maestro tests

Fuzz modifiers (require --test-fuzz):
  --fuzz-seed <num>          Base seed for fuzz RNG (default: epoch millis; each shard adds its index)
  --fuzz-steps <num>         Max fuzz steps (optional; default: unbounded when time budget is set)
  --fuzz-time-budget <dur>   Time budget for fuzz run (default 30m; e.g. 120s, 10m)
  --fuzz-last-interactions N Last-N interactions stored per issue (default 50)
  --fuzz-retain-success N    Keep last N successful sessions (default 10)
  --fuzz-min-session-steps N Minimum steps per session (default 200)
  --fuzz-no-progress-steps N End session after N unchanged steps (default 20)
  --fuzz-progress-timeout <dur> Progress watchdog timeout (default 5s; e.g. 5000ms, 5s)

Contract test modifiers (require --test-contract):
  --contract-mode safe|unsafe
  --contract-auth on|off
  --contract-password <pw>
  --contract-allow-reset
  --contract-disk <path>
  --contract-disk-drive a|b
  --contract-disk-type <type>
  --contract-disk-mode <mode>
  --contract-sid <path>
  --contract-sid-song <num>
  --contract-prg <path>
  --contract-prg-action run|load
  --c64u-target mock|real (required)
  --c64u-host <hostname>

Smoke test modifiers (require --test-smoke):
  --c64u-target mock|real   mock=emulator only, real=emulator + real target
  --c64u-host <hostname>    Hostname/IP for real target (default: C64U)

  -h, --help               Show this help

Examples:
  ./build
  ./build --skip-tests
  ./build --install-apk --device-id R5CRC3ZY9XH
  ./build --apk-path /path/to/app-debug.apk --install-apk
  ./build --emulator
  ./build --screenshots
  ./build --screenshots-only
  ./build --video
  ./build --test-e2e --record-traces --trace-suite playback
  ./build --test-contract --c64u-target mock --contract-mode safe --contract-auth off
  ./build --test-smoke --c64u-target real --c64u-host C64U

Notes:
  --screenshots       Runs full build/tests by default, then captures screenshots.
  --screenshots-only  Captures screenshots without running tests or Android builds.
  --video             Records a Playwright walkthrough video.
  --test-e2e          Runs Playwright E2E tests excluding @screenshots.
  --test-e2e-ci       Runs the CI mirror (E2E + screenshots + evidence validation).
  --test-fuzz         Always targets mock devices; --c64u-target real is rejected.
  --coverage          Runs unit + E2E coverage regardless of test category.
  Playwright port     Auto-selected to avoid clashes; set PLAYWRIGHT_PORT to pin a specific port.
EOF
}

log() {
  printf "\n==> %s\n" "$1"
}

record_flag() {
  local -n target="$1"
  target+=("$2")
}

set_primary_action() {
  local action="$1"
  local flag="$2"
  if [[ -n "$PRIMARY_ACTION" ]]; then
    echo "Multiple primary actions: ${PRIMARY_ACTION_SOURCE} and ${flag}" >&2
    exit 1
  fi
  PRIMARY_ACTION="$action"
  PRIMARY_ACTION_SOURCE="$flag"
}

is_test_action() {
  case "$PRIMARY_ACTION" in
    test-unit|test-e2e|test-e2e-ci|test-maestro-ci|test-maestro-all|test-maestro-tags|test-fuzz|test-contract|test-smoke)
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

require_value() {
  local flag="$1"
  local value="$2"
  if [[ -z "$value" || "$value" == "--"* ]]; then
    echo "Error: ${flag} requires a value" >&2
    exit 1
  fi
}

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "Missing command: $1" >&2
    exit 1
  fi
}

is_local_port_in_use() {
  local port="$1"
  node -e "const net = require('net'); const port = Number(process.argv[1]); const socket = net.createConnection({ host: '127.0.0.1', port }); const fail = () => process.exit(1); socket.setTimeout(400); socket.on('connect', () => { socket.destroy(); process.exit(0); }); socket.on('timeout', fail); socket.on('error', fail);" "$port" >/dev/null 2>&1
}

ensure_playwright_port() {
  if [[ "$PLAYWRIGHT_PORT_RESOLVED" == "true" ]]; then
    return
  fi
  PLAYWRIGHT_PORT_RESOLVED=true

  if [[ -n "${PLAYWRIGHT_PORT:-}" ]]; then
    if [[ ! "${PLAYWRIGHT_PORT}" =~ ^[0-9]+$ ]]; then
      echo "Invalid PLAYWRIGHT_PORT: ${PLAYWRIGHT_PORT}" >&2
      exit 1
    fi
    log "Using configured Playwright port: ${PLAYWRIGHT_PORT}"
    return
  fi

  local base_port="${PLAYWRIGHT_PORT_BASE:-4173}"
  if [[ ! "${base_port}" =~ ^[0-9]+$ ]]; then
    echo "Invalid PLAYWRIGHT_PORT_BASE: ${PLAYWRIGHT_PORT_BASE}" >&2
    exit 1
  fi

  local start_port=$((base_port + ((RANDOM + $$) % 200)))
  local max_tries=500
  local selected_port=""
  for ((i = 0; i < max_tries; i += 1)); do
    local candidate=$((start_port + i))
    if [[ "$candidate" -gt 65535 ]]; then
      break
    fi
    if ! is_local_port_in_use "$candidate"; then
      selected_port="$candidate"
      break
    fi
  done

  if [[ -z "$selected_port" ]]; then
    echo "Could not find a free Playwright port (base=${base_port}, tries=${max_tries})." >&2
    exit 1
  fi

  export PLAYWRIGHT_PORT="$selected_port"
  if [[ "$selected_port" == "$base_port" ]]; then
    log "Using Playwright port: ${PLAYWRIGHT_PORT}"
  else
    log "Playwright default port ${base_port} unavailable; using ${PLAYWRIGHT_PORT}"
  fi
}

run_contract_test() {
  local mode_raw="${CONTRACT_MODE,,}"
  local mode="SAFE"
  if [[ "$mode_raw" == "unsafe" ]]; then
    mode="STRESS"
  elif [[ "$mode_raw" != "safe" ]]; then
    echo "Invalid --contract-mode: ${CONTRACT_MODE}" >&2
    exit 1
  fi

  local auth_raw="${CONTRACT_AUTH,,}"
  local auth="OFF"
  if [[ "$auth_raw" == "on" ]]; then
    auth="ON"
  elif [[ "$auth_raw" != "off" ]]; then
    echo "Invalid --contract-auth: ${CONTRACT_AUTH}" >&2
    exit 1
  fi

  if [[ "$auth" == "ON" && -z "$CONTRACT_PASSWORD" ]]; then
    echo "--contract-password is required when auth=on" >&2
    exit 1
  fi

  if [[ -n "$CONTRACT_DISK_DRIVE" && "$CONTRACT_DISK_DRIVE" != "a" && "$CONTRACT_DISK_DRIVE" != "b" ]]; then
    echo "Invalid --contract-disk-drive: ${CONTRACT_DISK_DRIVE}" >&2
    exit 1
  fi

  if [[ -n "$CONTRACT_DISK_MODE" && "$CONTRACT_DISK_MODE" != "readwrite" && "$CONTRACT_DISK_MODE" != "readonly" && "$CONTRACT_DISK_MODE" != "unlinked" ]]; then
    echo "Invalid --contract-disk-mode: ${CONTRACT_DISK_MODE}" >&2
    exit 1
  fi

  if [[ -n "$CONTRACT_PRG_ACTION" && "$CONTRACT_PRG_ACTION" != "run" && "$CONTRACT_PRG_ACTION" != "load" ]]; then
    echo "Invalid --contract-prg-action: ${CONTRACT_PRG_ACTION}" >&2
    exit 1
  fi

  local base_url="http://${C64U_HOST}"
  local config_path
  config_path="$(mktemp -t c64u-contract-test.XXXXXX.json)"
  trap 'rm -f "$config_path"' RETURN

  export CONTRACT_TEST_BASE_URL="$base_url"
  export CONTRACT_TEST_MODE_UPPER="$mode"
  export CONTRACT_TEST_AUTH_UPPER="$auth"
  export CONTRACT_TEST_PASSWORD
  export CONTRACT_TEST_ALLOW_RESET
  export CONTRACT_TEST_DISK_PATH
  export CONTRACT_TEST_DISK_DRIVE
  export CONTRACT_TEST_DISK_TYPE
  export CONTRACT_TEST_DISK_MODE
  export CONTRACT_TEST_SID_PATH
  export CONTRACT_TEST_SID_SONGNR
  export CONTRACT_TEST_PRG_PATH
  export CONTRACT_TEST_PRG_ACTION
  export CONTRACT_TEST_TARGET="$C64U_TARGET"

  node --input-type=module - "$config_path" <<'NODE'
import fs from 'node:fs';

const outPath = process.argv[2];
const cfg = {
  baseUrl: process.env.CONTRACT_TEST_BASE_URL,
  mode: process.env.CONTRACT_TEST_MODE_UPPER,
  auth: process.env.CONTRACT_TEST_AUTH_UPPER,
  ftpMode: 'PASV',
  ftpPort: 21,
  outputDir: 'test-results/contract',
  concurrency: { restMaxInFlight: 2, ftpMaxSessions: 1, mixedMaxInFlight: 2 },
  pacing: { restMinDelayMs: 100, ftpMinDelayMs: 100 },
  health: { endpoint: '/v1/version', intervalMs: 5000, timeoutMs: 2000 },
  timeouts: { restTimeoutMs: 8000, ftpTimeoutMs: 15000, scenarioTimeoutMs: 120000, maxDestructiveScenarioMs: 180000 },
  scratch: { ftpDir: '/Temp/contract-test' },
};

if (cfg.auth === 'ON') {
  cfg.password = process.env.CONTRACT_TEST_PASSWORD;
}

if (process.env.CONTRACT_TEST_ALLOW_RESET === 'true') {
  cfg.allowMachineReset = true;
}

const media = {};
if (process.env.CONTRACT_TEST_DISK_PATH) {
  media.diskImagePath = process.env.CONTRACT_TEST_DISK_PATH;
  media.diskDrive = process.env.CONTRACT_TEST_DISK_DRIVE || 'a';
  media.diskType = process.env.CONTRACT_TEST_DISK_TYPE || 'd64';
  media.diskMode = process.env.CONTRACT_TEST_DISK_MODE || 'readonly';
}
if (process.env.CONTRACT_TEST_SID_PATH) {
  media.sidFilePath = process.env.CONTRACT_TEST_SID_PATH;
  if (process.env.CONTRACT_TEST_SID_SONGNR) {
    const songNr = Number(process.env.CONTRACT_TEST_SID_SONGNR);
    if (Number.isFinite(songNr)) media.sidSongNr = songNr;
  }
}
if (process.env.CONTRACT_TEST_PRG_PATH) {
  media.prgFilePath = process.env.CONTRACT_TEST_PRG_PATH;
  media.prgAction = process.env.CONTRACT_TEST_PRG_ACTION || 'run';
}
if (Object.keys(media).length) {
  cfg.media = media;
}

fs.writeFileSync(outPath, JSON.stringify(cfg, null, 2));
NODE

  log "Running contract test harness (${mode}/${auth}) against ${base_url}"
  local harness_status=0
  set +e
  (cd "$ROOT_DIR" && npx tsc -p tests/contract/tsconfig.json)
  local tsc_status=$?
  (cd "$ROOT_DIR" && node tests/contract/dist/run.js --config "$config_path")
  local run_status=$?
  set -e
  if [[ "$tsc_status" -ne 0 || "$run_status" -ne 0 ]]; then
    echo "Contract test harness failed (tsc=${tsc_status}, run=${run_status})" >&2
    harness_status=1
  fi

  if [[ "$harness_status" -ne 0 ]]; then
    exit 1
  fi
}

run_android_instrumentation() {
  log "Running Android instrumentation tests"
  require_cmd adb
  if ! adb devices | awk 'NR>1 && $2=="device" {print $1}' | grep -q .; then
    echo "No adb devices found. Start an emulator or connect a device, or omit --android-tests." >&2
    exit 1
  fi
  (cd "$ROOT_DIR" && timeout 30m ./android/gradlew -p android connectedDebugAndroidTest)
}

ensure_maestro_emulator() {
  if [[ -n "$TEST_DEVICE_ID" ]]; then
    return
  fi
  require_cmd adb
  adb start-server >/dev/null 2>&1 || true
  local emulator_id
  emulator_id=$(adb devices | awk 'NR>1 && $2=="device" && $1 ~ /^emulator-/ {print $1; exit}')
  if [[ -z "$emulator_id" ]]; then
    log "No Android emulator detected; starting emulator for Maestro"
    "$ROOT_DIR/scripts/android-emulator.sh" --no-prereqs --no-build --no-apk --no-install
  fi

  local deadline=$((SECONDS + 180))
  while [[ -z "$emulator_id" && $SECONDS -lt $deadline ]]; do
    emulator_id=$(adb devices | awk 'NR>1 && $2=="device" && $1 ~ /^emulator-/ {print $1; exit}')
    if [[ -z "$emulator_id" ]]; then
      sleep 2
    fi
  done

  if [[ -z "$emulator_id" ]]; then
    echo "No Android emulator detected for Maestro after start attempt." >&2
    exit 1
  fi

  TEST_DEVICE_ID="$emulator_id"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --test-unit)
      set_primary_action "test-unit" "$1"
      shift
      ;;
    --test-e2e)
      set_primary_action "test-e2e" "$1"
      shift
      ;;
    --test-e2e-ci)
      set_primary_action "test-e2e-ci" "$1"
      shift
      ;;
    --test-maestro-ci)
      set_primary_action "test-maestro-ci" "$1"
      shift
      ;;
    --test-maestro-all)
      set_primary_action "test-maestro-all" "$1"
      shift
      ;;
    --test-maestro-tags)
      require_value "$1" "${2:-}"
      set_primary_action "test-maestro-tags" "$1"
      MAESTRO_TAGS="$2"
      shift 2
      ;;
    --test-fuzz)
      set_primary_action "test-fuzz" "$1"
      shift
      ;;
    --test-contract)
      set_primary_action "test-contract" "$1"
      shift
      ;;
    --test-smoke)
      set_primary_action "test-smoke" "$1"
      shift
      ;;
    --screenshots)
      set_primary_action "screenshots" "$1"
      shift
      ;;
    --screenshots-only)
      set_primary_action "screenshots-only" "$1"
      shift
      ;;
    --video)
      set_primary_action "video" "$1"
      shift
      ;;
    --emulator)
      set_primary_action "emulator" "$1"
      shift
      ;;
    --dump-c64u-config)
      set_primary_action "dump-c64u-config" "$1"
      shift
      ;;
    --skip-install)
      record_flag BUILD_FLAGS "$1"
      SKIP_INSTALL=true
      shift
      ;;
    --skip-build)
      record_flag BUILD_FLAGS "$1"
      SKIP_BUILD=true
      shift
      ;;
    --skip-tests)
      record_flag BUILD_FLAGS "$1"
      SKIP_TESTS=true
      shift
      ;;
    --skip-apk)
      record_flag BUILD_FLAGS "$1"
      SKIP_APK=true
      shift
      ;;
    --skip-format)
      record_flag BUILD_FLAGS "$1"
      SKIP_FORMAT=true
      shift
      ;;
    --install-apk)
      record_flag BUILD_FLAGS "$1"
      INSTALL_APK=true
      shift
      ;;
    --apk-path)
      record_flag BUILD_FLAGS "$1"
      require_value "$1" "${2:-}"
      APK_PATH="$2"
      shift 2
      ;;
    --device-id)
      record_flag BUILD_FLAGS "$1"
      if [[ -n "${2:-}" && "${2:-}" != "--"* ]]; then
        DEVICE_ID="$2"
        shift 2
      else
        DEVICE_ID=""
        shift
      fi
      ;;
    --coverage)
      record_flag TEST_MODIFIERS "$1"
      RUN_COVERAGE=true
      shift
      ;;
    --validate-evidence)
      record_flag TEST_MODIFIERS "$1"
      RUN_VALIDATE_EVIDENCE=true
      shift
      ;;
    --record-traces)
      record_flag TEST_MODIFIERS "$1"
      RECORD_TRACES=true
      shift
      ;;
    --trace-output-dir)
      record_flag TEST_MODIFIERS "$1"
      require_value "$1" "${2:-}"
      TRACE_OUTPUT_DIR="$2"
      shift 2
      ;;
    --trace-suite)
      record_flag TEST_MODIFIERS "$1"
      require_value "$1" "${2:-}"
      TRACE_SUITE="$2"
      shift 2
      ;;
    --devices)
      record_flag TEST_MODIFIERS "$1"
      require_value "$1" "${2:-}"
      PLAYWRIGHT_DEVICES="$2"
      export PLAYWRIGHT_DEVICES
      shift 2
      ;;
    --android-tests)
      record_flag TEST_MODIFIERS "$1"
      RUN_ANDROID_TESTS=true
      shift
      ;;
    --skip-android-tests)
      record_flag TEST_MODIFIERS "$1"
      RUN_ANDROID_TESTS=false
      shift
      ;;
    --skip-android-coverage)
      record_flag TEST_MODIFIERS "$1"
      RUN_ANDROID_COVERAGE=false
      shift
      ;;
    --test-apk-path)
      record_flag TEST_APK_FLAGS "$1"
      require_value "$1" "${2:-}"
      TEST_APK_PATH="$2"
      shift 2
      ;;
    --test-device-id)
      record_flag TEST_APK_FLAGS "$1"
      require_value "$1" "${2:-}"
      TEST_DEVICE_ID="$2"
      shift 2
      ;;
    --fuzz-seed)
      record_flag FUZZ_FLAGS "$1"
      require_value "$1" "${2:-}"
      FUZZ_SEED="$2"
      shift 2
      ;;
    --fuzz-steps)
      record_flag FUZZ_FLAGS "$1"
      require_value "$1" "${2:-}"
      FUZZ_STEPS="$2"
      shift 2
      ;;
    --fuzz-time-budget)
      record_flag FUZZ_FLAGS "$1"
      require_value "$1" "${2:-}"
      FUZZ_TIME_BUDGET="$2"
      shift 2
      ;;
    --fuzz-last-interactions)
      record_flag FUZZ_FLAGS "$1"
      require_value "$1" "${2:-}"
      FUZZ_LAST_INTERACTIONS="$2"
      shift 2
      ;;
    --fuzz-retain-success)
      record_flag FUZZ_FLAGS "$1"
      require_value "$1" "${2:-}"
      FUZZ_RETAIN_SUCCESS="$2"
      shift 2
      ;;
    --fuzz-min-session-steps)
      record_flag FUZZ_FLAGS "$1"
      require_value "$1" "${2:-}"
      FUZZ_MIN_SESSION_STEPS="$2"
      shift 2
      ;;
    --fuzz-no-progress-steps)
      record_flag FUZZ_FLAGS "$1"
      require_value "$1" "${2:-}"
      FUZZ_NO_PROGRESS_STEPS="$2"
      shift 2
      ;;
    --fuzz-progress-timeout)
      record_flag FUZZ_FLAGS "$1"
      require_value "$1" "${2:-}"
      FUZZ_PROGRESS_TIMEOUT="$2"
      shift 2
      ;;
    --contract-mode)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_MODE="$2"
      shift 2
      ;;
    --contract-auth)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_AUTH="$2"
      shift 2
      ;;
    --contract-password)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_PASSWORD="$2"
      shift 2
      ;;
    --contract-allow-reset)
      record_flag CONTRACT_FLAGS "$1"
      CONTRACT_ALLOW_RESET=true
      shift
      ;;
    --contract-disk)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_DISK_PATH="$2"
      shift 2
      ;;
    --contract-disk-drive)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_DISK_DRIVE="$2"
      shift 2
      ;;
    --contract-disk-type)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_DISK_TYPE="$2"
      shift 2
      ;;
    --contract-disk-mode)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_DISK_MODE="$2"
      shift 2
      ;;
    --contract-sid)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_SID_PATH="$2"
      shift 2
      ;;
    --contract-sid-song)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_SID_SONGNR="$2"
      shift 2
      ;;
    --contract-prg)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_PRG_PATH="$2"
      shift 2
      ;;
    --contract-prg-action)
      record_flag CONTRACT_FLAGS "$1"
      require_value "$1" "${2:-}"
      CONTRACT_PRG_ACTION="$2"
      shift 2
      ;;
    --c64u-target)
      record_flag TARGET_FLAGS "$1"
      require_value "$1" "${2:-}"
      C64U_TARGET="$2"
      C64U_TARGET_SET=true
      shift 2
      ;;
    --c64u-host)
      record_flag TARGET_FLAGS "$1"
      require_value "$1" "${2:-}"
      C64U_HOST="$2"
      C64U_HOST_SET=true
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ -z "$PRIMARY_ACTION" ]]; then
  PRIMARY_ACTION="build"
fi

if [[ "$PRIMARY_ACTION" == "emulator" || "$PRIMARY_ACTION" == "dump-c64u-config" ]]; then
  if [[ ${#BUILD_FLAGS[@]} -gt 0 || ${#TEST_MODIFIERS[@]} -gt 0 || ${#TEST_APK_FLAGS[@]} -gt 0 || ${#FUZZ_FLAGS[@]} -gt 0 || ${#CONTRACT_FLAGS[@]} -gt 0 || ${#TARGET_FLAGS[@]} -gt 0 ]]; then
    echo "Tooling actions must run in isolation" >&2
    exit 1
  fi
fi

if [[ "$PRIMARY_ACTION" == "screenshots" || "$PRIMARY_ACTION" == "screenshots-only" || "$PRIMARY_ACTION" == "video" ]]; then
  if [[ ${#BUILD_FLAGS[@]} -gt 0 || ${#TEST_MODIFIERS[@]} -gt 0 || ${#TEST_APK_FLAGS[@]} -gt 0 || ${#FUZZ_FLAGS[@]} -gt 0 || ${#CONTRACT_FLAGS[@]} -gt 0 || ${#TARGET_FLAGS[@]} -gt 0 ]]; then
    echo "Screenshot actions must run in isolation" >&2
    exit 1
  fi
fi

if [[ "$PRIMARY_ACTION" != "build" && ${#BUILD_FLAGS[@]} -gt 0 ]]; then
  echo "Build flags are only valid for the default build action" >&2
  exit 1
fi

if ! is_test_action; then
  if [[ ${#TEST_MODIFIERS[@]} -gt 0 || ${#TEST_APK_FLAGS[@]} -gt 0 || ${#FUZZ_FLAGS[@]} -gt 0 || ${#CONTRACT_FLAGS[@]} -gt 0 || ${#TARGET_FLAGS[@]} -gt 0 ]]; then
    echo "Test modifiers require a --test-* primary action" >&2
    exit 1
  fi
fi

if [[ "$PRIMARY_ACTION" != "test-fuzz" && ${#FUZZ_FLAGS[@]} -gt 0 ]]; then
  echo "Fuzz modifiers require --test-fuzz" >&2
  exit 1
fi

if [[ "$PRIMARY_ACTION" != "test-contract" && ${#CONTRACT_FLAGS[@]} -gt 0 ]]; then
  echo "Contract test modifiers require --test-contract" >&2
  exit 1
fi

if [[ ${#TARGET_FLAGS[@]} -gt 0 ]]; then
  case "$PRIMARY_ACTION" in
    test-contract|test-maestro-ci|test-maestro-all|test-maestro-tags|test-smoke|test-fuzz)
      ;;
    *)
      echo "--c64u-target/--c64u-host are only valid with contract, Maestro, or smoke tests" >&2
      exit 1
      ;;
  esac
fi

if [[ "$C64U_TARGET_SET" == "true" && "$C64U_TARGET" != "mock" && "$C64U_TARGET" != "real" ]]; then
  echo "Invalid --c64u-target: ${C64U_TARGET}" >&2
  exit 1
fi

if [[ "$PRIMARY_ACTION" == "test-fuzz" ]]; then
  if [[ "$C64U_TARGET_SET" == "true" && "$C64U_TARGET" != "mock" ]]; then
    echo "Fuzz tests must target mock devices" >&2
    exit 1
  fi
  if [[ "$C64U_HOST_SET" == "true" ]]; then
    echo "Fuzz tests do not accept --c64u-host" >&2
    exit 1
  fi
fi

if [[ "$PRIMARY_ACTION" == "test-contract" && "$C64U_TARGET_SET" != "true" ]]; then
  echo "Contract tests require --c64u-target mock|real" >&2
  exit 1
fi

if [[ "$PRIMARY_ACTION" == "test-contract" && "$CONTRACT_ALLOW_RESET" == "true" && "${CONTRACT_MODE,,}" != "unsafe" ]]; then
  echo "--contract-allow-reset requires --contract-mode unsafe" >&2
  exit 1
fi

if [[ "$PRIMARY_ACTION" == "test-maestro-tags" && -z "$MAESTRO_TAGS" ]]; then
  echo "--test-maestro-tags requires a value" >&2
  exit 1
fi

RUN_INSTALL=true
RUN_BUILD=true
RUN_TEST=true
RUN_APK=true
RUN_FORMAT=true
RUN_INSTALL_APK=false
RUN_SCREENSHOTS=false
RUN_SCREENSHOTS_ONLY=false
RUN_VIDEO=false
RUN_TEST_UNIT=false
RUN_TEST_E2E=false
RUN_TEST_E2E_CI=false
RUN_TEST_MAESTRO_CI=false
RUN_TEST_MAESTRO_ALL=false
RUN_TEST_MAESTRO_TAGS=false
RUN_FUZZ=false
RUN_CONTRACT_TEST=false
RUN_SMOKE_ANDROID_EMULATOR=false
RUN_SMOKE_ANDROID_REAL=false
RUN_EMULATOR=false
RUN_DUMP_C64U_CONFIG=false

case "$PRIMARY_ACTION" in
  build)
    RUN_INSTALL="$([[ "$SKIP_INSTALL" == "true" ]] && echo false || echo true)"
    RUN_BUILD="$([[ "$SKIP_BUILD" == "true" ]] && echo false || echo true)"
    RUN_TEST="$([[ "$SKIP_TESTS" == "true" ]] && echo false || echo true)"
    RUN_APK="$([[ "$SKIP_APK" == "true" ]] && echo false || echo true)"
    RUN_FORMAT="$([[ "$SKIP_FORMAT" == "true" ]] && echo false || echo true)"
    RUN_INSTALL_APK="$INSTALL_APK"
    ;;
  test-unit)
    RUN_TEST=false
    RUN_TEST_UNIT=true
    RUN_APK=false
    ;;
  test-e2e)
    RUN_TEST=false
    RUN_TEST_E2E=true
    RUN_APK=false
    ;;
  test-e2e-ci)
    RUN_TEST=false
    RUN_TEST_E2E_CI=true
    RUN_APK=false
    ;;
  test-maestro-ci)
    RUN_TEST=false
    RUN_TEST_MAESTRO_CI=true
    ;;
  test-maestro-all)
    RUN_TEST=false
    RUN_TEST_MAESTRO_ALL=true
    ;;
  test-maestro-tags)
    RUN_TEST=false
    RUN_TEST_MAESTRO_TAGS=true
    ;;
  test-fuzz)
    RUN_TEST=false
    RUN_FUZZ=true
    RUN_APK=false
    ;;
  test-contract)
    RUN_TEST=false
    RUN_BUILD=false
    RUN_APK=false
    RUN_CONTRACT_TEST=true
    ;;
  test-smoke)
    RUN_TEST=false
    RUN_SMOKE_ANDROID_EMULATOR=true
    RUN_SMOKE_ANDROID_REAL=false
    if [[ "$C64U_TARGET" == "real" ]]; then
      RUN_SMOKE_ANDROID_REAL=true
    fi
    ;;
  screenshots)
    RUN_SCREENSHOTS=true
    ;;
  screenshots-only)
    RUN_SCREENSHOTS=true
    RUN_SCREENSHOTS_ONLY=true
    RUN_TEST=false
    RUN_TEST_UNIT=false
    RUN_TEST_E2E=false
    RUN_TEST_E2E_CI=false
    RUN_TEST_MAESTRO_CI=false
    RUN_TEST_MAESTRO_ALL=false
    RUN_TEST_MAESTRO_TAGS=false
    RUN_APK=false
    RUN_INSTALL_APK=false
    ;;
  video)
    RUN_VIDEO=true
    RUN_TEST=false
    RUN_TEST_UNIT=false
    RUN_TEST_E2E=false
    RUN_TEST_E2E_CI=false
    RUN_TEST_MAESTRO_CI=false
    RUN_TEST_MAESTRO_ALL=false
    RUN_TEST_MAESTRO_TAGS=false
    RUN_APK=false
    RUN_INSTALL_APK=false
    ;;
  emulator)
    RUN_EMULATOR=true
    ;;
  dump-c64u-config)
    RUN_DUMP_C64U_CONFIG=true
    ;;
esac

if [[ "$RUN_EMULATOR" == "true" ]]; then
  log "Starting Android emulator flow"
  "$ROOT_DIR/scripts/android-emulator.sh"
  exit 0
fi

if [[ "$RUN_DUMP_C64U_CONFIG" == "true" ]]; then
  CONFIG_HOST="c64u"
  if [[ "$C64U_HOST_SET" == "true" ]]; then
    CONFIG_HOST="$C64U_HOST"
  fi
  log "Dumping C64U config"
  (cd "$ROOT_DIR/scripts" && ./dump_c64u_config.py \
    --base-url "http://${CONFIG_HOST}" \
    --output "$ROOT_DIR/doc/c64/c64u-config.yaml")
  exit 0
fi

require_cmd npm

if [[ -x /usr/lib/jvm/java-17-openjdk-amd64/bin/jlink ]]; then
  export JAVA_HOME="/usr/lib/jvm/java-17-openjdk-amd64"
  export PATH="$JAVA_HOME/bin:$PATH"
fi

if command -v git >/dev/null 2>&1; then
  if [[ -z "${VITE_GIT_SHA:-}" ]]; then
    export VITE_GIT_SHA="$(git -C "$ROOT_DIR" rev-parse --short HEAD 2>/dev/null || true)"
  fi
  if [[ -z "${VITE_APP_VERSION:-}" ]]; then
    GIT_TAG="$(git -C "$ROOT_DIR" describe --tags --exact-match 2>/dev/null || true)"
    if [[ -n "$GIT_TAG" ]]; then
      export VITE_APP_VERSION="$GIT_TAG"
    fi
  fi
fi
if [[ -z "${VITE_BUILD_TIME:-}" ]]; then
  export VITE_BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
fi
if [[ -z "${VITE_APP_VERSION:-}" && -f "$ROOT_DIR/package.json" ]]; then
  export VITE_APP_VERSION="$(node -p "require('./package.json').version" 2>/dev/null || true)"
fi
if [[ -n "${VITE_APP_VERSION:-}" && -z "${VERSION_NAME:-}" ]]; then
  export VERSION_NAME="$VITE_APP_VERSION"
fi
if [[ -z "$APK_DEFAULT" ]]; then
  APK_DEFAULT="$ROOT_DIR/android/app/build/outputs/apk/debug/c64commander-${VITE_APP_VERSION:-unknown}-debug.apk"
fi

if [[ "$RECORD_TRACES" == "true" ]]; then
  export RECORD_TRACES=1
  if [[ -n "$TRACE_OUTPUT_DIR" ]]; then
    export TRACE_OUTPUT_DIR
  fi
  if [[ -n "$TRACE_SUITE" ]]; then
    export TRACE_SUITE
  fi
fi

if [[ "$RUN_INSTALL" == "true" ]]; then
  log "Installing npm dependencies"
  (cd "$ROOT_DIR" && npm install --no-audit --no-fund)
fi

if [[ "$RUN_CONTRACT_TEST" == "true" ]]; then
  run_contract_test
fi

if [[ "$RUN_BUILD" == "true" && "$RUN_FORMAT" == "true" ]]; then
  log "Formatting repository"
  (cd "$ROOT_DIR" && npm run format)
fi

if [[ "$RUN_BUILD" == "true" ]]; then
  log "Building web app + syncing Capacitor"
  (cd "$ROOT_DIR" && npm run cap:build)

  if [[ -f "$ROOT_DIR/android/capacitor-cordova-android-plugins/build.gradle" ]]; then
    sed -i.bak '/flatDir{/,/}/d' "$ROOT_DIR/android/capacitor-cordova-android-plugins/build.gradle"
    rm -f "$ROOT_DIR/android/capacitor-cordova-android-plugins/build.gradle.bak"
  fi
fi

if [[ "$RUN_SCREENSHOTS_ONLY" == "true" && "$RUN_BUILD" == "false" ]]; then
  if [[ ! -f "$ROOT_DIR/dist/index.html" ]]; then
    echo "Missing dist/index.html. Run without --skip-build or build assets first." >&2
    exit 1
  fi
fi

if [[ "$RUN_TEST" == "true" || "$RUN_TEST_E2E" == "true" || "$RUN_TEST_E2E_CI" == "true" || "$RUN_SCREENSHOTS" == "true" || "$RUN_VIDEO" == "true" || "$RUN_FUZZ" == "true" ]]; then
  ensure_playwright_port
fi

if [[ "$RUN_TEST" == "true" ]]; then
  log "Running tests"
  (cd "$ROOT_DIR" && npm test)
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  if [[ "$RUN_SCREENSHOTS" == "true" ]]; then
    (cd "$ROOT_DIR" && PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" npm run test:e2e)
  else
    (cd "$ROOT_DIR" && PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" npx playwright test --grep-invert @screenshots)
  fi
  (cd "$ROOT_DIR/android" && ./gradlew test --warning-mode none)
  if [[ "$RUN_ANDROID_TESTS" == "true" ]]; then
    run_android_instrumentation
  fi
fi

if [[ "$RUN_TEST_UNIT" == "true" ]]; then
  log "Running unit tests"
  (cd "$ROOT_DIR" && npm test)
fi

if [[ "$RUN_TEST_E2E" == "true" ]]; then
  log "Running E2E tests"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  (cd "$ROOT_DIR" && PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" npx playwright test --grep-invert @screenshots)
fi

if [[ "$RUN_TEST_E2E_CI" == "true" ]]; then
  log "Running CI mirror (screenshots + E2E + validation)"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  (cd "$ROOT_DIR" && PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" npm run test:e2e:ci)
fi

if [[ "$RUN_VALIDATE_EVIDENCE" == "true" ]]; then
  log "Validating Playwright evidence"
  (cd "$ROOT_DIR" && npm run validate:evidence)
fi

if [[ "$RUN_COVERAGE" == "true" ]]; then
  log "Running coverage (unit + e2e)"
  (cd "$ROOT_DIR" && ./scripts/collect-coverage.sh)
  (cd "$ROOT_DIR" && EXPECT_WEB_COVERAGE=1 node scripts/verify-coverage-artifacts.mjs)
  (cd "$ROOT_DIR" && COVERAGE_MIN=75 node scripts/check-coverage-threshold.mjs)
  if [[ "$RUN_ANDROID_COVERAGE" == "true" ]]; then
    log "Running Android coverage verification"
    (cd "$ROOT_DIR" && ./android/gradlew -p android testDebugUnitTest jacocoTestCoverageVerification)
    (cd "$ROOT_DIR" && EXPECT_ANDROID_COVERAGE=1 node scripts/verify-coverage-artifacts.mjs)
  fi
  if [[ "$RUN_ANDROID_TESTS" == "true" ]]; then
    run_android_instrumentation
  fi
fi

if [[ "$RUN_SCREENSHOTS" == "true" ]]; then
  log "Capturing screenshots"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  (cd "$ROOT_DIR" && \
    VITE_GIT_SHA="screenshots" \
    VITE_BUILD_TIME="1970-01-01T00:00:00Z" \
    SOURCE_DATE_EPOCH="0" \
    PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" \
    npm run screenshots)
fi

if [[ "$RUN_VIDEO" == "true" ]]; then
  log "Recording walkthrough video"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  (cd "$ROOT_DIR" && \
    PLAYWRIGHT_DEVICES="${PLAYWRIGHT_DEVICES:-phone}" \
    PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-1}" \
    npm run video)
fi

if [[ "$RUN_FUZZ" == "true" ]]; then
  log "Running fuzz test runner"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  FUZZ_ARGS=()
  if [[ -n "$FUZZ_SEED" ]]; then FUZZ_ARGS+=(--fuzz-seed "$FUZZ_SEED"); fi
  if [[ -n "$FUZZ_STEPS" ]]; then FUZZ_ARGS+=(--fuzz-steps "$FUZZ_STEPS"); fi
  if [[ -n "$FUZZ_TIME_BUDGET" ]]; then FUZZ_ARGS+=(--fuzz-time-budget "$FUZZ_TIME_BUDGET"); fi
  if [[ -n "$FUZZ_LAST_INTERACTIONS" ]]; then FUZZ_ARGS+=(--fuzz-last-interactions "$FUZZ_LAST_INTERACTIONS"); fi
  if [[ -n "$FUZZ_RETAIN_SUCCESS" ]]; then FUZZ_ARGS+=(--fuzz-retain-success "$FUZZ_RETAIN_SUCCESS"); fi
  if [[ -n "$FUZZ_MIN_SESSION_STEPS" ]]; then FUZZ_ARGS+=(--fuzz-min-session-steps "$FUZZ_MIN_SESSION_STEPS"); fi
  if [[ -n "$FUZZ_NO_PROGRESS_STEPS" ]]; then FUZZ_ARGS+=(--fuzz-no-progress-steps "$FUZZ_NO_PROGRESS_STEPS"); fi
  if [[ -n "$FUZZ_PROGRESS_TIMEOUT" ]]; then FUZZ_ARGS+=(--fuzz-progress-timeout "$FUZZ_PROGRESS_TIMEOUT"); fi
  if [[ "$RUN_BUILD" == "true" || -f "$ROOT_DIR/dist/index.html" ]]; then
    export PLAYWRIGHT_SKIP_BUILD=1
  fi
  (cd "$ROOT_DIR" && FUZZ_RUN_MODE="local" node scripts/run-fuzz.mjs "${FUZZ_ARGS[@]}")
fi

if [[ "$RUN_APK" == "true" ]]; then
  log "Building debug APK"
  (cd "$ROOT_DIR" && npm run android:apk -- --warning-mode none)
fi

if [[ "$RUN_TEST_MAESTRO_CI" == "true" || "$RUN_TEST_MAESTRO_ALL" == "true" || "$RUN_TEST_MAESTRO_TAGS" == "true" ]]; then
  ensure_maestro_emulator
  log "Running Maestro tests"
  MAESTRO_MODE=""
  if [[ "$RUN_TEST_MAESTRO_CI" == "true" ]]; then
    MAESTRO_MODE="ci"
  elif [[ "$RUN_TEST_MAESTRO_ALL" == "true" ]]; then
    MAESTRO_MODE="all"
  else
    MAESTRO_MODE="tags"
  fi
  MAESTRO_APK_PATH="${TEST_APK_PATH:-$APK_DEFAULT}"
  MAESTRO_ARGS=(--mode "$MAESTRO_MODE" --apk-path "$MAESTRO_APK_PATH" --c64u-target "$C64U_TARGET" --c64u-host "$C64U_HOST")
  if [[ -n "$TEST_DEVICE_ID" ]]; then
    MAESTRO_ARGS+=(--device-id "$TEST_DEVICE_ID")
  fi
  if [[ "$RUN_TEST_MAESTRO_TAGS" == "true" ]]; then
    MAESTRO_ARGS+=(--tags "$MAESTRO_TAGS")
  fi
  (cd "$ROOT_DIR" && bash scripts/run-maestro.sh "${MAESTRO_ARGS[@]}")
fi

if [[ "$RUN_SMOKE_ANDROID_EMULATOR" == "true" ]]; then
  log "Running Android emulator smoke test"
  SMOKE_APK_PATH="${TEST_APK_PATH:-$ROOT_DIR/android/app/build/outputs/apk/debug/app-debug.apk}"
  (cd "$ROOT_DIR" && bash scripts/smoke-android-emulator.sh \
    --c64u-target "mock" \
    --apk-path "$SMOKE_APK_PATH")
  if [[ "$RUN_SMOKE_ANDROID_REAL" == "true" ]]; then
    REAL_HOST="$C64U_HOST"
    if [[ "$C64U_HOST_SET" != "true" ]]; then
      REAL_HOST="auto"
    fi
    (cd "$ROOT_DIR" && bash scripts/smoke-android-emulator.sh \
      --c64u-target "real" \
      --c64u-host "$REAL_HOST" \
      --apk-path "$SMOKE_APK_PATH")
  fi
  log "Validating Android emulator evidence"
  (cd "$ROOT_DIR" && node scripts/validate-android-emulator-evidence.mjs)
fi

if [[ "$RUN_ANDROID_TESTS" == "true" && "$RUN_TEST" != "true" && "$RUN_COVERAGE" != "true" ]]; then
  run_android_instrumentation
fi

if [[ "$RUN_INSTALL_APK" == "true" ]]; then
  require_cmd adb
  APK_PATH="${APK_PATH:-$APK_DEFAULT}"

  if [[ ! -f "$APK_PATH" ]]; then
    echo "APK not found: $APK_PATH" >&2
    exit 1
  fi

  if [[ -z "$DEVICE_ID" ]]; then
    mapfile -t DEVICES < <(adb devices | awk 'NR>1 && $2=="device" {print $1}' | grep -v '^emulator-')
    if [[ ${#DEVICES[@]} -eq 0 ]]; then
      echo "No adb devices found. Connect a device or pass --device-id <id>." >&2
      exit 1
    fi
    DEVICE_ID="${DEVICES[0]}"
  fi

  log "Installing APK to device: $DEVICE_ID"
  adb -s "$DEVICE_ID" install -r "$APK_PATH"

  log "Launching app"
  adb -s "$DEVICE_ID" shell monkey -p uk.gleissner.c64commander -c android.intent.category.LAUNCHER 1
fi

log "Done"
