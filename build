#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APK_DEFAULT=""

RUN_INSTALL=true
RUN_BUILD=true
RUN_TEST=true
RUN_ANDROID_TESTS=false
RUN_APK=true
RUN_INSTALL_APK=false
RUN_EMULATOR=false
RUN_SCREENSHOTS=false
RUN_TEST_UNIT=false
RUN_TEST_E2E=false
RUN_TEST_E2E_CI=false
RUN_TEST_MAESTRO_CI=false
RUN_TEST_MAESTRO_ALL=false
RUN_TEST_MAESTRO_TAGS=false
RUN_VALIDATE_EVIDENCE=false
RUN_COVERAGE=false
RUN_ANDROID_COVERAGE=true
RUN_SCREENSHOTS_ONLY=false
RUN_FUZZ=false
RUN_SMOKE_ANDROID_EMULATOR=false
RUN_SMOKE_ANDROID_REAL=false
RUN_FORMAT=true
RUN_DUMP_C64U_CONFIG=false
PLAYWRIGHT_DEVICES=""
PLAYWRIGHT_PORT_RESOLVED=false
APK_PATH=""
DEVICE_ID=""
FUZZ_SEED=""
FUZZ_STEPS=""
FUZZ_TIME_BUDGET=""
FUZZ_LAST_INTERACTIONS=""
FUZZ_RETAIN_SUCCESS=""
FUZZ_MIN_SESSION_STEPS=""
FUZZ_NO_PROGRESS_STEPS=""
FUZZ_PROGRESS_TIMEOUT=""
C64U_TARGET="mock"
C64U_HOST="C64U"
C64U_TARGET_SET=false
C64U_HOST_SET=false
RECORD_TRACES=false
TRACE_OUTPUT_DIR=""
TRACE_SUITE=""
MAESTRO_TAGS=""
GRADLE_MAX_WORKERS="${GRADLE_MAX_WORKERS:-6}"
export GRADLE_MAX_WORKERS

usage() {
  cat <<'EOF'
build - C64 Commander local build helper

Usage:
  ./build [options]

Default (no options):
  - Install deps
  - Build web app + sync
  - Run tests
  - Build debug APK

Options:
  --emulator            Run scripts/android-emulator.sh and exit
  --install             Install APK to a connected Android device (via adb)
  --device [id]         Device ID for adb (optional). If omitted, picks the first real phone.
  --apk-path <path>     APK path to install (default: android/app/build/outputs/apk/debug/app-debug.apk)

  --test                Run unit tests only (vitest)
  --test-e2e            Run E2E tests only (Playwright, no screenshots)
  --test-e2e-ci         Run full CI mirror (screenshots + e2e + validation)
  --test-maestro-ci     Run Maestro CI flows (ci-critical tag)
  --test-maestro-all    Run all Maestro flows (ignores excludeTags)
  --test-maestro-tags <tags> Run Maestro flows by tags (+include/-exclude)
  --validate-evidence   Validate Playwright evidence structure
  --coverage            Run unit + e2e coverage (slower)
  --record-traces       Record golden traces during Playwright runs
  --trace-output-dir <path> Output directory for golden traces (default: playwright/fixtures/traces/golden)
  --trace-suite <name>  Optional suite name to scope trace recording
  --android-tests       Run Android instrumentation tests (requires a device/emulator)
  --skip-android-tests  Skip Android instrumentation tests
  --skip-android-coverage Skip Android Jacoco coverage check
  --smoke-android-emulator Run Android emulator smoke test (mock target only)
  --smoke-android-real  Also run emulator smoke test against real target (requires flag)
  --c64u-target mock|real   Target for emulator smoke (default: mock; real requires --smoke-android-real)
  --c64u-host <hostname>    Hostname/IP for real target (default: C64U)
  --fuzz                Run Playwright chaos fuzz runner (mock device only)
  --fuzz-seed <num>          Base seed for fuzz RNG (default: epoch millis; each shard adds its index)
  --fuzz-steps <num>         Max fuzz steps (optional; default: unbounded when time budget is set)
  --fuzz-time-budget <dur>   Time budget for fuzz run (default 30m; e.g. 120s, 10m)
  --fuzz-last-interactions N Last-N interactions stored per issue (default 50)
  --fuzz-retain-success N    Keep last N successful sessions (default 10)
  --fuzz-min-session-steps N Minimum steps per session (default 200)
  --fuzz-no-progress-steps N End session after N unchanged steps (default 20)
  --fuzz-progress-timeout <dur> Progress watchdog timeout (default 5s; e.g. 5000ms, 5s)

  --devices <list>      Device profiles for Playwright (phone, tablet, phone,tablet, all)
  --skip-format         Skip repository auto-formatting before build steps
  --skip-install        Skip npm install
  --skip-build          Skip npm run cap:build
  --skip-tests          Skip npm test
  --skip-apk            Skip npm run android:apk
  --screenshots         Capture app screenshots into doc/img
  --screenshots-only    Capture screenshots only (no tests, no APK, no Android)
  --dump-c64u-config     Dump C64U config to doc/c64/c64u-config.yaml and exit

  -h, --help            Show this help

Examples:
  ./build
  ./build --skip-tests
  ./build --install --device R5CRC3ZY9XH
  ./build --apk-path /path/to/app-debug.apk --install
  ./build --emulator
  ./build --screenshots
  ./build --screenshots-only
  ./build --test-e2e --record-traces --trace-suite playback

Notes:
  --screenshots       Runs full build/tests by default, then captures screenshots.
  --screenshots-only  Captures screenshots without running tests or Android builds.
  --test-e2e          Runs Playwright E2E tests excluding @screenshots.
  --test-e2e-ci       Runs the CI mirror (E2E + screenshots + evidence validation).
  Playwright port     Auto-selected to avoid clashes; set PLAYWRIGHT_PORT to pin a specific port.
EOF
}

log() {
  printf "\n==> %s\n" "$1"
}

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "Missing command: $1" >&2
    exit 1
  fi
}

is_local_port_in_use() {
  local port="$1"
  node -e "const net = require('net'); const port = Number(process.argv[1]); const socket = net.createConnection({ host: '127.0.0.1', port }); const fail = () => process.exit(1); socket.setTimeout(400); socket.on('connect', () => { socket.destroy(); process.exit(0); }); socket.on('timeout', fail); socket.on('error', fail);" "$port" >/dev/null 2>&1
}

ensure_playwright_port() {
  if [[ "$PLAYWRIGHT_PORT_RESOLVED" == "true" ]]; then
    return
  fi
  PLAYWRIGHT_PORT_RESOLVED=true

  if [[ -n "${PLAYWRIGHT_PORT:-}" ]]; then
    if [[ ! "${PLAYWRIGHT_PORT}" =~ ^[0-9]+$ ]]; then
      echo "Invalid PLAYWRIGHT_PORT: ${PLAYWRIGHT_PORT}" >&2
      exit 1
    fi
    log "Using configured Playwright port: ${PLAYWRIGHT_PORT}"
    return
  fi

  local base_port="${PLAYWRIGHT_PORT_BASE:-4173}"
  if [[ ! "${base_port}" =~ ^[0-9]+$ ]]; then
    echo "Invalid PLAYWRIGHT_PORT_BASE: ${PLAYWRIGHT_PORT_BASE}" >&2
    exit 1
  fi

  local start_port=$((base_port + ((RANDOM + $$) % 200)))
  local max_tries=500
  local selected_port=""
  for ((i = 0; i < max_tries; i += 1)); do
    local candidate=$((start_port + i))
    if [[ "$candidate" -gt 65535 ]]; then
      break
    fi
    if ! is_local_port_in_use "$candidate"; then
      selected_port="$candidate"
      break
    fi
  done

  if [[ -z "$selected_port" ]]; then
    echo "Could not find a free Playwright port (base=${base_port}, tries=${max_tries})." >&2
    exit 1
  fi

  export PLAYWRIGHT_PORT="$selected_port"
  if [[ "$selected_port" == "$base_port" ]]; then
    log "Using Playwright port: ${PLAYWRIGHT_PORT}"
  else
    log "Playwright default port ${base_port} unavailable; using ${PLAYWRIGHT_PORT}"
  fi
}

run_android_instrumentation() {
  log "Running Android instrumentation tests"
  require_cmd adb
  if ! adb devices | awk 'NR>1 && $2=="device" {print $1}' | grep -q .; then
    echo "No adb devices found. Start an emulator or connect a device, or omit --android-tests." >&2
    exit 1
  fi
  (cd "$ROOT_DIR" && timeout 30m ./android/gradlew -p android connectedDebugAndroidTest)
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --emulator)
      RUN_EMULATOR=true
      shift
      ;;
    --install)
      RUN_INSTALL_APK=true
      shift
      ;;
    --test)
      RUN_TEST_UNIT=true
      RUN_BUILD=true
      RUN_INSTALL=true
      RUN_APK=false
      RUN_TEST=false
      shift
      ;;
    --test-e2e)
      RUN_TEST_E2E=true
      RUN_BUILD=true
      RUN_INSTALL=true
      RUN_APK=false
      RUN_TEST=false
      shift
      ;;
    --test-e2e-ci)
      RUN_TEST_E2E_CI=true
      RUN_BUILD=true
      RUN_INSTALL=true
      RUN_APK=false
      RUN_TEST=false
      shift
      ;;
    --test-maestro-ci)
      RUN_TEST_MAESTRO_CI=true
      RUN_BUILD=true
      RUN_INSTALL=true
      RUN_APK=true
      RUN_TEST=false
      RUN_TEST_UNIT=false
      RUN_TEST_E2E=false
      RUN_TEST_E2E_CI=false
      RUN_VALIDATE_EVIDENCE=false
      RUN_COVERAGE=false
      RUN_ANDROID_TESTS=false
      RUN_ANDROID_COVERAGE=false
      shift
      ;;
    --test-maestro-all)
      RUN_TEST_MAESTRO_ALL=true
      RUN_BUILD=true
      RUN_INSTALL=true
      RUN_APK=true
      RUN_TEST=false
      RUN_TEST_UNIT=false
      RUN_TEST_E2E=false
      RUN_TEST_E2E_CI=false
      RUN_VALIDATE_EVIDENCE=false
      RUN_COVERAGE=false
      RUN_ANDROID_TESTS=false
      RUN_ANDROID_COVERAGE=false
      shift
      ;;
    --test-maestro-tags)
      if [[ -n "${2:-}" && "${2:-}" != "--"* ]]; then
        RUN_TEST_MAESTRO_TAGS=true
        MAESTRO_TAGS="$2"
        RUN_BUILD=true
        RUN_INSTALL=true
        RUN_APK=true
        RUN_TEST=false
        RUN_TEST_UNIT=false
        RUN_TEST_E2E=false
        RUN_TEST_E2E_CI=false
        RUN_VALIDATE_EVIDENCE=false
        RUN_COVERAGE=false
        RUN_ANDROID_TESTS=false
        RUN_ANDROID_COVERAGE=false
        shift 2
      else
        echo "Error: --test-maestro-tags requires a value" >&2
        exit 1
      fi
      ;;
    --validate-evidence)
      RUN_VALIDATE_EVIDENCE=true
      RUN_BUILD=false
      RUN_INSTALL=false
      RUN_APK=false
      RUN_TEST=false
      shift
      ;;
    --coverage)
      RUN_COVERAGE=true
      RUN_BUILD=true
      RUN_INSTALL=true
      RUN_APK=false
      RUN_TEST=false
      shift
      ;;
    --fuzz)
      RUN_FUZZ=true
      RUN_BUILD=true
      RUN_INSTALL=true
      RUN_TEST=false
      RUN_TEST_UNIT=false
      RUN_TEST_E2E=false
      RUN_TEST_E2E_CI=false
      RUN_VALIDATE_EVIDENCE=false
      RUN_COVERAGE=false
      RUN_ANDROID_TESTS=false
      RUN_ANDROID_COVERAGE=false
      RUN_APK=false
      RUN_INSTALL_APK=false
      shift
      ;;
    --android-tests)
      RUN_ANDROID_TESTS=true
      shift
      ;;
    --record-traces)
      RECORD_TRACES=true
      shift
      ;;
    --trace-output-dir)
      TRACE_OUTPUT_DIR="$2"
      shift 2
      ;;
    --trace-suite)
      TRACE_SUITE="$2"
      shift 2
      ;;
    --skip-android-tests)
      RUN_ANDROID_TESTS=false
      shift
      ;;
    --skip-android-coverage)
      RUN_ANDROID_COVERAGE=false
      shift
      ;;
    --fuzz-seed)
      FUZZ_SEED="$2"
      shift 2
      ;;
    --fuzz-steps)
      FUZZ_STEPS="$2"
      shift 2
      ;;
    --fuzz-time-budget)
      FUZZ_TIME_BUDGET="$2"
      shift 2
      ;;
    --fuzz-last-interactions)
      FUZZ_LAST_INTERACTIONS="$2"
      shift 2
      ;;
    --fuzz-retain-success)
      FUZZ_RETAIN_SUCCESS="$2"
      shift 2
      ;;
    --fuzz-min-session-steps)
      FUZZ_MIN_SESSION_STEPS="$2"
      shift 2
      ;;
    --fuzz-no-progress-steps)
      FUZZ_NO_PROGRESS_STEPS="$2"
      shift 2
      ;;
    --fuzz-progress-timeout)
      FUZZ_PROGRESS_TIMEOUT="$2"
      shift 2
      ;;
    --devices)
      if [[ -n "${2:-}" && "${2:-}" != "--"* ]]; then
        PLAYWRIGHT_DEVICES="$2"
        export PLAYWRIGHT_DEVICES
        shift 2
      else
        echo "Error: --devices requires a value" >&2
        exit 1
      fi
      ;;
    --device)
      if [[ -n "${2:-}" && "${2:-}" != "--"* ]]; then
        DEVICE_ID="$2"
        shift 2
      else
        DEVICE_ID=""
        shift
      fi
      ;;
    --apk-path)
      APK_PATH="$2"
      shift 2
      ;;
    --skip-install)
      RUN_INSTALL=false
      shift
      ;;
    --skip-format)
      RUN_FORMAT=false
      shift
      ;;
    --skip-build)
      RUN_BUILD=false
      shift
      ;;
    --skip-tests)
      RUN_TEST=false
      shift
      ;;
    --skip-apk)
      RUN_APK=false
      shift
      ;;
    --screenshots)
      RUN_SCREENSHOTS=true
      shift
      ;;
    --screenshots-only)
      RUN_SCREENSHOTS_ONLY=true
      RUN_SCREENSHOTS=true
      RUN_TEST=false
      RUN_TEST_UNIT=false
      RUN_TEST_E2E=false
      RUN_TEST_E2E_CI=false
      RUN_VALIDATE_EVIDENCE=false
      RUN_COVERAGE=false
      RUN_ANDROID_TESTS=false
      RUN_ANDROID_COVERAGE=false
      RUN_APK=false
      RUN_INSTALL_APK=false
      shift
      ;;
    --dump-c64u-config)
      RUN_DUMP_C64U_CONFIG=true
      shift
      ;;
    --smoke-android-emulator)
      RUN_SMOKE_ANDROID_EMULATOR=true
      if [[ "$RUN_BUILD" != "false" ]]; then
        RUN_BUILD=true
      fi
      if [[ "$RUN_APK" != "false" ]]; then
        RUN_APK=true
      fi
      RUN_TEST=false
      RUN_TEST_UNIT=false
      RUN_TEST_E2E=false
      RUN_TEST_E2E_CI=false
      RUN_VALIDATE_EVIDENCE=false
      RUN_COVERAGE=false
      RUN_ANDROID_TESTS=false
      RUN_ANDROID_COVERAGE=false
      shift
      ;;
    --smoke-android-real)
      RUN_SMOKE_ANDROID_REAL=true
      RUN_SMOKE_ANDROID_EMULATOR=true
      if [[ "$RUN_BUILD" != "false" ]]; then
        RUN_BUILD=true
      fi
      if [[ "$RUN_APK" != "false" ]]; then
        RUN_APK=true
      fi
      RUN_TEST=false
      RUN_TEST_UNIT=false
      RUN_TEST_E2E=false
      RUN_TEST_E2E_CI=false
      RUN_VALIDATE_EVIDENCE=false
      RUN_COVERAGE=false
      RUN_ANDROID_TESTS=false
      RUN_ANDROID_COVERAGE=false
      shift
      ;;
    --c64u-target)
      C64U_TARGET="$2"
      C64U_TARGET_SET=true
      shift 2
      ;;
    --c64u-host)
      C64U_HOST="$2"
      C64U_HOST_SET=true
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ "$RUN_SCREENSHOTS_ONLY" == "true" ]]; then
  RUN_TEST=false
  RUN_TEST_UNIT=false
  RUN_TEST_E2E=false
  RUN_TEST_E2E_CI=false
  RUN_TEST_MAESTRO_CI=false
  RUN_TEST_MAESTRO_ALL=false
  RUN_TEST_MAESTRO_TAGS=false
  RUN_VALIDATE_EVIDENCE=false
  RUN_COVERAGE=false
  RUN_ANDROID_TESTS=false
  RUN_ANDROID_COVERAGE=false
  RUN_APK=false
  RUN_INSTALL_APK=false
fi

if [[ "$RUN_EMULATOR" == "true" ]]; then
  log "Starting Android emulator flow"
  "$ROOT_DIR/scripts/android-emulator.sh"
  exit 0
fi

if [[ "$RUN_DUMP_C64U_CONFIG" == "true" ]]; then
  CONFIG_HOST="c64u"
  if [[ "$C64U_HOST_SET" == "true" ]]; then
    CONFIG_HOST="$C64U_HOST"
  fi
  log "Dumping C64U config"
  (cd "$ROOT_DIR/scripts" && ./dump_c64u_config.py \
    --base-url "http://${CONFIG_HOST}" \
    --output "$ROOT_DIR/doc/c64/c64u-config.yaml")
  exit 0
fi

require_cmd npm

if [[ -x /usr/lib/jvm/java-17-openjdk-amd64/bin/jlink ]]; then
  export JAVA_HOME="/usr/lib/jvm/java-17-openjdk-amd64"
  export PATH="$JAVA_HOME/bin:$PATH"
fi

if command -v git >/dev/null 2>&1; then
  if [[ -z "${VITE_GIT_SHA:-}" ]]; then
    export VITE_GIT_SHA="$(git -C "$ROOT_DIR" rev-parse --short HEAD 2>/dev/null || true)"
  fi
  if [[ -z "${VITE_APP_VERSION:-}" ]]; then
    GIT_TAG="$(git -C "$ROOT_DIR" describe --tags --exact-match 2>/dev/null || true)"
    if [[ -n "$GIT_TAG" ]]; then
      export VITE_APP_VERSION="$GIT_TAG"
    fi
  fi
fi
if [[ -z "${VITE_BUILD_TIME:-}" ]]; then
  export VITE_BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
fi
if [[ -z "${VITE_APP_VERSION:-}" && -f "$ROOT_DIR/package.json" ]]; then
  export VITE_APP_VERSION="$(node -p "require('./package.json').version" 2>/dev/null || true)"
fi
if [[ -n "${VITE_APP_VERSION:-}" && -z "${VERSION_NAME:-}" ]]; then
  export VERSION_NAME="$VITE_APP_VERSION"
fi
if [[ -z "$APK_DEFAULT" ]]; then
  APK_DEFAULT="$ROOT_DIR/android/app/build/outputs/apk/debug/c64commander-${VITE_APP_VERSION:-unknown}-debug.apk"
fi

if [[ "$RECORD_TRACES" == "true" ]]; then
  export RECORD_TRACES=1
  if [[ -n "$TRACE_OUTPUT_DIR" ]]; then
    export TRACE_OUTPUT_DIR
  fi
  if [[ -n "$TRACE_SUITE" ]]; then
    export TRACE_SUITE
  fi
fi

if [[ "$RUN_INSTALL" == "true" ]]; then
  log "Installing npm dependencies"
  (cd "$ROOT_DIR" && npm install --no-audit --no-fund)
fi

if [[ "$RUN_BUILD" == "true" && "$RUN_FORMAT" == "true" ]]; then
  log "Formatting repository"
  (cd "$ROOT_DIR" && npm run format)
fi

if [[ "$RUN_BUILD" == "true" ]]; then
  log "Building web app + syncing Capacitor"
  (cd "$ROOT_DIR" && npm run cap:build)

  if [[ -f "$ROOT_DIR/android/capacitor-cordova-android-plugins/build.gradle" ]]; then
    sed -i.bak '/flatDir{/,/}/d' "$ROOT_DIR/android/capacitor-cordova-android-plugins/build.gradle"
    rm -f "$ROOT_DIR/android/capacitor-cordova-android-plugins/build.gradle.bak"
  fi
fi

if [[ "$RUN_SCREENSHOTS_ONLY" == "true" && "$RUN_BUILD" == "false" ]]; then
  if [[ ! -f "$ROOT_DIR/dist/index.html" ]]; then
    echo "Missing dist/index.html. Run without --skip-build or build assets first." >&2
    exit 1
  fi
fi

if [[ "$RUN_TEST" == "true" || "$RUN_TEST_E2E" == "true" || "$RUN_TEST_E2E_CI" == "true" || "$RUN_SCREENSHOTS" == "true" || "$RUN_FUZZ" == "true" ]]; then
  ensure_playwright_port
fi

if [[ "$RUN_TEST" == "true" ]]; then
  log "Running tests"
  (cd "$ROOT_DIR" && npm test)
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  if [[ "$RUN_SCREENSHOTS" == "true" ]]; then
    (cd "$ROOT_DIR" && PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" npm run test:e2e)
  else
    (cd "$ROOT_DIR" && PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" npx playwright test --grep-invert @screenshots)
  fi
  (cd "$ROOT_DIR/android" && ./gradlew test --warning-mode none)
  if [[ "$RUN_ANDROID_TESTS" == "true" ]]; then
    run_android_instrumentation
  fi
fi

if [[ "$RUN_TEST_UNIT" == "true" ]]; then
  log "Running unit tests"
  (cd "$ROOT_DIR" && npm test)
fi

if [[ "$RUN_TEST_E2E" == "true" ]]; then
  log "Running E2E tests"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  (cd "$ROOT_DIR" && PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" npx playwright test --grep-invert @screenshots)
fi

if [[ "$RUN_TEST_E2E_CI" == "true" ]]; then
  log "Running CI mirror (screenshots + E2E + validation)"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  (cd "$ROOT_DIR" && PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" npm run test:e2e:ci)
fi

if [[ "$RUN_VALIDATE_EVIDENCE" == "true" ]]; then
  log "Validating Playwright evidence"
  (cd "$ROOT_DIR" && npm run validate:evidence)
fi

if [[ "$RUN_COVERAGE" == "true" ]]; then
  log "Running coverage (unit + e2e)"
  (cd "$ROOT_DIR" && ./scripts/collect-coverage.sh)
  (cd "$ROOT_DIR" && EXPECT_WEB_COVERAGE=1 node scripts/verify-coverage-artifacts.mjs)
  (cd "$ROOT_DIR" && COVERAGE_MIN=75 node scripts/check-coverage-threshold.mjs)
  if [[ "$RUN_ANDROID_COVERAGE" == "true" ]]; then
    log "Running Android coverage verification"
    (cd "$ROOT_DIR" && ./android/gradlew -p android testDebugUnitTest jacocoTestCoverageVerification)
    (cd "$ROOT_DIR" && EXPECT_ANDROID_COVERAGE=1 node scripts/verify-coverage-artifacts.mjs)
  fi
  if [[ "$RUN_ANDROID_TESTS" == "true" ]]; then
    run_android_instrumentation
  fi
fi

if [[ "$RUN_SCREENSHOTS" == "true" ]]; then
  log "Capturing screenshots"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  (cd "$ROOT_DIR" && \
    VITE_GIT_SHA="screenshots" \
    VITE_BUILD_TIME="1970-01-01T00:00:00Z" \
    SOURCE_DATE_EPOCH="0" \
    PLAYWRIGHT_WORKERS="${PLAYWRIGHT_WORKERS:-4}" \
    npm run screenshots)
fi

if [[ "$RUN_FUZZ" == "true" ]]; then
  log "Running chaos fuzz runner"
  (cd "$ROOT_DIR" && npx playwright install --check >/dev/null 2>&1 || npx playwright install)
  FUZZ_ARGS=()
  if [[ -n "$FUZZ_SEED" ]]; then FUZZ_ARGS+=(--fuzz-seed "$FUZZ_SEED"); fi
  if [[ -n "$FUZZ_STEPS" ]]; then FUZZ_ARGS+=(--fuzz-steps "$FUZZ_STEPS"); fi
  if [[ -n "$FUZZ_TIME_BUDGET" ]]; then FUZZ_ARGS+=(--fuzz-time-budget "$FUZZ_TIME_BUDGET"); fi
  if [[ -n "$FUZZ_LAST_INTERACTIONS" ]]; then FUZZ_ARGS+=(--fuzz-last-interactions "$FUZZ_LAST_INTERACTIONS"); fi
  if [[ -n "$FUZZ_RETAIN_SUCCESS" ]]; then FUZZ_ARGS+=(--fuzz-retain-success "$FUZZ_RETAIN_SUCCESS"); fi
  if [[ -n "$FUZZ_MIN_SESSION_STEPS" ]]; then FUZZ_ARGS+=(--fuzz-min-session-steps "$FUZZ_MIN_SESSION_STEPS"); fi
  if [[ -n "$FUZZ_NO_PROGRESS_STEPS" ]]; then FUZZ_ARGS+=(--fuzz-no-progress-steps "$FUZZ_NO_PROGRESS_STEPS"); fi
  if [[ -n "$FUZZ_PROGRESS_TIMEOUT" ]]; then FUZZ_ARGS+=(--fuzz-progress-timeout "$FUZZ_PROGRESS_TIMEOUT"); fi
  if [[ "$RUN_BUILD" == "true" || -f "$ROOT_DIR/dist/index.html" ]]; then
    export PLAYWRIGHT_SKIP_BUILD=1
  fi
  (cd "$ROOT_DIR" && FUZZ_RUN_MODE="local" node scripts/run-fuzz.mjs "${FUZZ_ARGS[@]}")
fi

if [[ "$RUN_APK" == "true" ]]; then
  log "Building debug APK"
  (cd "$ROOT_DIR" && npm run android:apk -- --warning-mode none)
fi

if [[ "$RUN_TEST_MAESTRO_CI" == "true" || "$RUN_TEST_MAESTRO_ALL" == "true" || "$RUN_TEST_MAESTRO_TAGS" == "true" ]]; then
  log "Running Maestro tests"
  MAESTRO_MODE=""
  if [[ "$RUN_TEST_MAESTRO_CI" == "true" ]]; then
    MAESTRO_MODE="ci"
  elif [[ "$RUN_TEST_MAESTRO_ALL" == "true" ]]; then
    MAESTRO_MODE="all"
  else
    MAESTRO_MODE="tags"
  fi
  MAESTRO_APK_PATH="${APK_PATH:-$APK_DEFAULT}"
  MAESTRO_ARGS=(--mode "$MAESTRO_MODE" --apk-path "$MAESTRO_APK_PATH" --c64u-target "$C64U_TARGET" --c64u-host "$C64U_HOST")
  if [[ -n "$DEVICE_ID" ]]; then
    MAESTRO_ARGS+=(--device-id "$DEVICE_ID")
  fi
  if [[ "$RUN_TEST_MAESTRO_TAGS" == "true" ]]; then
    MAESTRO_ARGS+=(--tags "$MAESTRO_TAGS")
  fi
  (cd "$ROOT_DIR" && bash scripts/run-maestro.sh "${MAESTRO_ARGS[@]}")
fi

if [[ "$RUN_SMOKE_ANDROID_EMULATOR" == "true" ]]; then
  log "Running Android emulator smoke test"
  SMOKE_APK_PATH="${APK_PATH:-$ROOT_DIR/android/app/build/outputs/apk/debug/app-debug.apk}"
  if [[ "$C64U_TARGET_SET" == "true" && "$C64U_TARGET" == "real" && "$RUN_SMOKE_ANDROID_REAL" != "true" ]]; then
    echo "--c64u-target real requires --smoke-android-real" >&2
    exit 1
  fi
  if [[ "$C64U_TARGET_SET" == "true" && "$C64U_TARGET" == "mock" ]]; then
    (cd "$ROOT_DIR" && bash scripts/smoke-android-emulator.sh \
      --c64u-target "mock" \
      --apk-path "$SMOKE_APK_PATH")
  else
    (cd "$ROOT_DIR" && bash scripts/smoke-android-emulator.sh \
      --c64u-target "mock" \
      --apk-path "$SMOKE_APK_PATH")
  fi
  if [[ "$RUN_SMOKE_ANDROID_REAL" == "true" ]]; then
    REAL_HOST="$C64U_HOST"
    if [[ "$C64U_HOST_SET" != "true" ]]; then
      REAL_HOST="auto"
    fi
    (cd "$ROOT_DIR" && bash scripts/smoke-android-emulator.sh \
      --c64u-target "real" \
      --c64u-host "$REAL_HOST" \
      --apk-path "$SMOKE_APK_PATH")
  fi
  log "Validating Android emulator evidence"
  (cd "$ROOT_DIR" && node scripts/validate-android-emulator-evidence.mjs)
fi

if [[ "$RUN_INSTALL_APK" == "true" ]]; then
  require_cmd adb
  APK_PATH="${APK_PATH:-$APK_DEFAULT}"

  if [[ ! -f "$APK_PATH" ]]; then
    echo "APK not found: $APK_PATH" >&2
    exit 1
  fi

  if [[ -z "$DEVICE_ID" ]]; then
    mapfile -t DEVICES < <(adb devices | awk 'NR>1 && $2=="device" {print $1}' | grep -v '^emulator-')
    if [[ ${#DEVICES[@]} -eq 0 ]]; then
      echo "No adb devices found. Connect a device or pass --device <id>." >&2
      exit 1
    fi
    DEVICE_ID="${DEVICES[0]}"
  fi

  log "Installing APK to device: $DEVICE_ID"
  adb -s "$DEVICE_ID" install -r "$APK_PATH"

  log "Launching app"
  adb -s "$DEVICE_ID" shell monkey -p uk.gleissner.c64commander -c android.intent.category.LAUNCHER 1
fi

log "Done"
